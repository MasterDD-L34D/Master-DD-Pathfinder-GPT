# Staging sandbox log — dump toggle, CTA QA, export naming (2025-12-18)

- **Ambiente**: sandbox via `TestClient` FastAPI (stessa configurazione staging, `ALLOW_MODULE_DUMP=false` di default, API key richiesta).
- **Comando**: `pytest tests/test_app.py -q` — 53/53 test passati, 2 warning di deprecazione jsonschema.【80ed8e†L1-L12】
- **Playlist**: vedi `reports/staging_test_playlist.md` per i passi manuali/automatici eseguiti su dump, CTA QA e naming.【F:reports/staging_test_playlist.md†L1-L46】

## Evidenze per modulo
| Modulo | Dump policy | CTA / Gate QA | Naming export | Note/log |
| --- | --- | --- | --- | --- |
| Encounter_Designer | Troncamento e header `X-Content-*` applicati con dump off; full dump solo quando consentito.【F:src/app.py†L1517-L1580】 | Export bloccato senza `/validate_encounter` nello step 6.【F:src/modules/Encounter_Designer.txt†L387-L438】【F:src/modules/Encounter_Designer.txt†L505-L514】 | Export VTT/MD/PDF guidati da `export_filename` condiviso.【F:src/modules/Encounter_Designer.txt†L419-L438】 | Header di troncamento e flow QA verificati via playlist; nessun errore nei test automatizzati.【80ed8e†L1-L12】 |
| minmax_builder | 206 con marker `[contenuto troncato — …]` e blocco binari quando `ALLOW_MODULE_DUMP=false`.【F:src/app.py†L1517-L1580】 | Gate `export_requires`/`qa_check` obbligatori prima di export/benchmark.【F:src/modules/minmax_builder.txt†L1886-L1893】【F:src/modules/minmax_builder.txt†L2018-L2024】 | Nomenclatura condivisa `MinMax_<nome>.pdf/.xlsx/.json` per export VTT/PDF/Excel.【F:src/modules/minmax_builder.txt†L940-L943】【F:src/modules/minmax_builder.txt†L1224-L1225】 | Test automatizzati passati; header/403 coperti da pytest.【80ed8e†L1-L12】 |
| Taverna_NPC / tavern_hub | Dump parziale con marker/header quando il download è bloccato; export hub protetto.【F:src/modules/Taverna_NPC.txt†L1299-L1334】 | CTA remediation/quiz obbligatorie prima di export/report hub.【F:src/modules/Taverna_NPC.txt†L1299-L1334】 | Auto-naming su canvas/ledger (`taverna_saves`) senza raw dump.【F:src/modules/Taverna_NPC.txt†L1299-L1334】 | Flow CTA/export verificato via playlist; nessuna regressione nei test automatici.【80ed8e†L1-L12】 |
| narrative_flow | Header `x-truncated`/`x-original-length` e marker di troncamento rispettati con dump off.【F:src/modules/narrative_flow.txt†L334-L401】 | `/qa_story` imposta `ready_for_export` prima di ogni export narrativo.【F:src/modules/narrative_flow.txt†L334-L401】 | Export narrativo vincolato al flag QA (nessun file custom). | Verifica manuale dei flag QA e troncamento secondo playlist; suite pytest passata.【80ed8e†L1-L12】 |
| adventurer_ledger | Download bloccato quando `allow_module_dump` è false; header/marker applicati.【F:src/app.py†L1517-L1580】 | CTA di validazione delta WBL e export ledger/loot gating.【F:src/modules/adventurer_ledger.txt†L666-L688】【F:src/modules/adventurer_ledger.txt†L780-L783】 | Export ledger/loot/PG con naming guidato e binding scheda.【F:src/modules/adventurer_ledger.txt†L1101-L1127】 | Test automatici coprono blocco dump; nessuna issue aperta.【80ed8e†L1-L12】 |
