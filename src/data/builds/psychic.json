{
  "build_state": {
    "class": "Psychic",
    "mode": "extended",
    "race": "Human",
    "archetype": "Base",
    "step": 1,
    "step_total": 16,
    "step_labels": {
      "1": "Profilo Base",
      "2": "Razza & Classe",
      "3": "Archetipi & Multiclasse",
      "4": "Feats & Talenti",
      "5": "Spell & Power Set",
      "6": "Equip & Risorse",
      "7": "Benchmark & Simulazioni",
      "8": "QA & Export",
      "9": "Dummies Sheet",
      "10": "Esportazione",
      "11": "Fork/Varianti",
      "12": "Comparativa",
      "13": "Meta Rating",
      "14": "Companion",
      "15": "Report",
      "16": "Chiusura"
    },
    "statistics": {
      "FOR": 16,
      "DES": 14,
      "COS": 14,
      "INT": 10,
      "SAG": 12,
      "CAR": 8
    }
  },
  "benchmark": {
    "meta_tier": "T3",
    "ruling_badge": "validated",
    "dpr_snapshot": {
      "livello_1": {
        "media": 6,
        "picco": 9
      },
      "livello_5": {
        "media": 18,
        "picco": 26
      }
    },
    "statistics": {
      "attacco": "+4",
      "danni": "1d8+3",
      "ca": 17
    }
  },
  "export": {
    "sheet_payload": {
      "classi": [
        {
          "nome": "Psychic",
          "livelli": 1,
          "archetipi": [
            "Base"
          ]
        }
      ],
      "statistiche": {
        "FOR": 16,
        "DES": 14,
        "COS": 14,
        "INT": 10,
        "SAG": 12,
        "CAR": 8
      },
      "statistiche_chiave": {
        "attacco": "+4",
        "danni": "1d8+3",
        "ca": 17
      },
      "benchmarks": {
        "meta_tier": "T3"
      },
      "salvezze": {
        "Tempra": 0,
        "Riflessi": 0,
        "Volont√†": 0,
        "tempra": 0,
        "riflessi": 0,
        "volonta": 0
      },
      "ledger": {
        "movimenti": [
          {
            "voce": "Equipaggiamento iniziale",
            "importo": -150
          },
          {
            "voce": "Ricompensa missione",
            "importo": 250
          }
        ],
        "currency": {
          "oro": 100,
          "argento": 25,
          "rame": 40
        }
      },
      "print_mode": false,
      "show_minmax": true,
      "show_vtt": true,
      "show_qa": true,
      "show_explain": true,
      "show_ledger": true,
      "decimal_comma": true,
      "AC_arm": 0,
      "AC_scudo": 0,
      "AC_des": 0,
      "AC_defl": 0,
      "AC_nat": 0,
      "AC_dodge": 0,
      "AC_misc": 0,
      "AC_base": 10,
      "AC_tot": 17,
      "CA_touch": 10,
      "CA_ff": 10,
      "modules": {
        "scheda_pg_markdown_template.md": "### üßô Scheda Personaggio in Markdown\n\n---\n\n{# ========== SETUP & MACROS ========== #}\n{% set PRINT_MODE    = print_mode    | default(false) %}\n{% set SHOW_MINMAX   = show_minmax   | default(true)  %}\n{% set SHOW_VTT      = show_vtt      | default(true)  %}\n{% set SHOW_QA       = show_qa       | default(true)  %}\n{% set SHOW_EXPLAIN  = show_explain  | default(true)  %}\n{% set SHOW_LEDGER   = show_ledger   | default(true)  %}  {# <-- nuovo: Libro Mastro #}\n{% set DECIMAL_COMMA = decimal_comma | default(true)  %}\n\n{% macro d(val, fallback='‚Äî') -%}{{ (val if (val is not none and val != '') else fallback) }}{%- endmacro %}\n{% macro mod(x) -%}{{ (((x|default(10))|int) - 10) // 2 }}{%- endmacro %}\n{% macro j(list, sep=', ') -%}{{ (list or []) | select('string') | list | join(sep) }}{%- endmacro %}\n{% macro signed(x) -%}{% if x is not none %}{{ \"+\" if x>=0 else \"\" }}{{ x }}{% else %}‚Äî{% endif %}{%- endmacro %}\n\n{# --- Monete / Valorizzazioni (per Adventurer Ledger) --- #}\n{% macro to_gp(pp=0,gp=0,sp=0,cp=0) -%}{{ (pp|float)*10 + (gp|float) + (sp|float)/10 + (cp|float)/100 }}{%- endmacro %}\n{% macro coin_str(pp=0,gp=0,sp=0,cp=0) -%}\nPP {{pp|default(0)}} ‚Ä¢ GP {{gp|default(0)}} ‚Ä¢ SP {{sp|default(0)}} ‚Ä¢ CP {{cp|default(0)}}\n{%- endmacro %}\n{% macro fmt_gp(x) -%}\n{%- set raw = ('{:.2f}'.format(x|float)).rstrip('0').rstrip('.') -%}\n{{ (raw.replace('.', ',') if DECIMAL_COMMA else raw) }} gp\n{%- endmacro %}\n\n{% set ST  = statistiche or {} %}\n{% set STK = statistiche_chiave or {} %}\n{% set SAL = salvezze or {} %}\n{% set BM  = benchmarks or {} %}\n\n{% set CL = classi or [] %}\n{% set FIRST_CLASS = (CL[0].nome if CL and CL|length>0 else '‚Äî') %}\n\n{# ----- CA: dodge separato + ricostruzione ----- #}\n{% set AC_arm   = AC_arm   | default(0) %}\n{% set AC_scudo = AC_scudo | default(0) %}\n{% set AC_des   = AC_des   | default(0) %}\n{% set AC_defl  = AC_defl  | default(0) %}\n{% set AC_nat   = AC_nat   | default(0) %}\n{% set AC_dodge = AC_dodge | default(0) %}\n{% set AC_misc  = AC_misc  | default(AC_altro | default(0)) %}\n\n{% set AC_tot = AC_tot if (AC_tot is not none)\n  else (10 + AC_arm + AC_scudo + AC_des + AC_defl + AC_nat + AC_dodge + AC_misc) %}\n\n{% set CA_touch = 10 + AC_des + AC_defl + AC_dodge + AC_misc %}\n{% set CA_ff    = 10 + AC_arm + AC_scudo + AC_defl + AC_nat + AC_misc %}\n\n{# ----- Spell table: robust ----- #}\n{% set spell_levels    = spell_levels or [] %}\n{% set has_spell_table = (spell_levels|length) > 0 %}\n\n{# Hook Percezione auto se presente skills_map #}\n{% set skills_map = skills_map or {} %}\n{% if skills_map and skills_map.Percezione and skills_map.Percezione.totale is not none %}\n  {% set percezione_tot = skills_map.Percezione.totale %}\n{% endif %}\n\n# {{ nome | default('‚Äî') }} ‚Äî Liv. {{ get_total_level(CL)|default('‚Äî') }} ({{ razza | default('‚Äî') }} ¬∑ {% for c in CL %}{{ c.nome }} ({{ c.livelli }}){% if c.archetipi %} ‚Äî {{ c.archetipi | join(', ') }}{% endif %}{% if not loop.last %} / {% endif %}{% endfor %})\n\n**Allineamento:** {{ d(allineamento) }}  \n**Divinit√†:** {{ d(divinita) }}  \n**Taglia:** {{ d(taglia) }} | **Et√†:** {{ d(eta) }} | **Sesso:** {{ d(sesso) }} | **Altezza/Peso:** {{ d(altezza) }} / {{ d(peso) }}  \n**Ruolo consigliato:** {{ d(ruolo) }}  \n**Stile interpretativo:** {{ d(player_style) }} ‚Äî {{ d(style_hint(player_style)) }}  \n**Background breve (5‚Äì10 righe):** {{ d(background) }}\n\n---\n\n## Statistiche fondamentali\n- **For** {{ ST.Forza|default(10) }} (mod {{ mod(ST.Forza) }})\n- **Des** {{ ST.Destrezza|default(10) }} (mod {{ mod(ST.Destrezza) }})\n- **Cos** {{ ST.Costituzione|default(10) }} (mod {{ mod(ST.Costituzione) }})\n- **Int** {{ ST.Intelligenza|default(10) }} (mod {{ mod(ST.Intelligenza) }})\n- **Sag** {{ ST.Saggezza|default(10) }} (mod {{ mod(ST.Saggezza) }})\n- **Car** {{ ST.Carisma|default(10) }} (mod {{ mod(ST.Carisma) }})\n\n- **PF (HP):** {{ d(STK.PF) }} | **CA:** {{ d(STK.CA, AC_tot) }}  \n- **CA (breakdown):** {{ AC_tot }} = 10 + Arm {{ AC_arm }} + Scudo {{ AC_scudo }} + Des {{ AC_des }} + Defl {{ AC_defl }} + Nat {{ AC_nat }} + Dodge {{ AC_dodge }} + Altro {{ AC_misc }}  \n- **CA Var.:** Contatto {{ CA_touch }} ¬∑ Colto alla sprovvista {{ CA_ff }}  \n- **Tiri Salvezza:** Temp {{ d(SAL.Tempra) }} / Riflessi {{ d(SAL.Riflessi) }} / Volont√† {{ d(SAL.Volont√†) }}  \n- **BAB:** {{ d(BAB) }} | **Iniziativa:** {{ d(init) }} | **Velocit√†:** {{ d(speed) }}  \n- **CMB/CMD:** {{ d(CMB) }} / {{ d(CMD) }}  \n\n{% set CMD_base = 10 + (BAB|default(0)) + (mod(ST.Forza) if use_str_for_cmd|default(true) else mod(ST.Destrezza)) + mod(ST.Destrezza) + size_mod_cmd|default(0) + cmd_altro|default(0) %}\n- **CMD (dettaglio):** {{ CMD|default(CMD_base) }} = 10 + BAB {{ BAB|default(0) }} + For/Des {{ (mod(ST.Forza) if use_str_for_cmd|default(true) else mod(ST.Destrezza)) }} + Des {{ mod(ST.Destrezza) }} + Taglia {{ size_mod_cmd|default(0) }} + Altro {{ cmd_altro|default(0) }}\n\n- **PE (XP):** {{ d(xp_correnti) }} / {{ d(xp_prossimo_livello) }}\n\n---\n\n## Difese Speciali\n- **RD/Res/Imm:** {{ d(rd_res_imm) }}  \n- **RS:** {{ d(rs) }} | **Guarigione rapida/Rigenerazione:** {{ d(heal_regen) }}  \n- **Sensi:** {{ d(sensi) }} | **Percezione (tot):** {{ d(percezione_tot) }}\n\n---\n\n## Combattimento\n### Armi e attacchi\n| Arma | Tipo | Attacco | Danni | Critico | Portata | Note |\n|---|---|---:|---|---|---|---|\n{% for a in (armi or []) -%}\n| {{ d(a.nome) }} | {{ d(a.tipo) }} | {{ d(a.attacco) }} | {{ d(a.danni) }} | {{ d(a.critico) }} | {{ d(a.portata) }} | {{ a.note | default('') }} |\n{%- endfor %}\n{% if (armi or [])|length == 0 %}_(Nessuna arma strutturata: derivabile da `equipaggiamento` o aggiungerla qui.)_{% endif %}\n\n- **Attacchi naturali:** {{ d(attacchi_naturali) }}  \n- **Capacit√† speciali:** {{ d(capitolo_capacita, capacita_speciali) }}\n\n### Manovre CMB\n| Manovra | Bonus |\n|---|---:|\n| Disarm | {{ d(cmb_disarm) }} |\n| Trip   | {{ d(cmb_trip) }} |\n| Grapple| {{ d(cmb_grapple) }} |\n| Bull Rush | {{ d(cmb_bull_rush) }} |\n| Sunder | {{ d(cmb_sunder) }} |\n\n---\n\n## Economia d‚ÄôAzione\n- **AoO/round:** {{ d(aoo_per_round) }}  \n- **Swift usata?:** {{ d(swift_used,'no') }}  \n- **Immediate pronte?:** {{ d(immediate_ready,'s√¨') }}\n\n---\n\n## Armatura (tecnica)\n- **ACP:** {{ d(acp) }} | **Max Des:** {{ d(max_dex) }} | **ASF:** {{ d(asf_pct) }}% | **Velocit√† ridotta:** {{ d(speed_armor_penalty) }}\n\n---\n\n## Abilit√† (Skills)\n| Abilit√† | Gradi | Mod Car | Var | Classe? | Totale |\n|---|---:|---:|---:|:--:|---:|\n{% for s in (skills or []) -%}\n| {{ d(s.nome) }} | {{ s.gradi|default(0) }} | {{ signed(s.mod_car|default(0)) }} | {{ signed(s.var|default(0)) }} | {{ '‚úì' if s.classe else '' }} | {{ s.totale|default(s.gradi|default(0) + s.mod_car|default(0) + s.var|default(0) + (3 if s.classe else 0)) }} |\n{%- endfor %}\n{% if (skills or [])|length == 0 %}_Nessuna abilit√† strutturata._{% endif %}\n\n---\n\n## Talenti, Tratti & Difetti\n- **Talenti:** {% set feats = (progressione or []) | map(attribute='talento') | select('string') | reject('equalto', None) | list %}{{ j(feats) or '‚Äî' }}\n- **Tratti:** {% if tratti %}{% for t in tratti %}{{ d(t.nome) }}{{ ', ' if not loop.last }}{% endfor %}{% else %}‚Äî{% endif %}\n- **Difetti:** {{ d(difetti) }}\n\n---\n\n## Poteri di Classe / Archetipi\n{{ d(poteri_classe) }}\n\n**Usi/giorno chiave:** {{ d(usi_giorno_chiave) }}\n\n---\n\n## Incantesimi / Capacit√† Magiche\n- **Classe da incantatore:** {{ d(classe_incantatore, FIRST_CLASS) }}  \n- **CD base incantesimi:** {{ d(spell_dc_base) }} | **LI:** {{ d(livello_incantatore) }}  \n- **Slot per giorno:** {{ d(slot_incantesimi) }}\n\n**Conosciuti/Preparati**\n{% for lvl in (magia or {}).keys() | map('int') | list | sort %}\n- **{{ lvl }}¬∞:** {{ (magia[lvl] or []) | join(', ') }}\n{% endfor %}\n{% if (magia or {})|length == 0 %}_Nessun incantesimo conosciuto o preparato specificato._{% endif %}\n\n{% if has_spell_table %}\n| Liv | Conosciuti | Preparati | Slot/giorno | CD |\n|---:|---:|---:|---:|---:|\n{% for sl in spell_levels -%}\n| {{ sl.liv }} | {{ d(sl.known) }} | {{ d(sl.prepared) }} | {{ d(sl.per_day) }} | {{ d(sl.dc) }} |\n{%- endfor %}\n{% else %}\n_Nessuna tabella incantesimi disponibile._\n{% endif %}\n\n### Incantatore (tecnico)\n{% if concentration_bonus is not none %}\n- **Concentrazione:** {{ concentration_bonus }}\n{% else %}\n- **Concentrazione (hint):** LI {{ d(livello_incantatore,0) }} + mod stat chiave + vari\n{% endif %}\n- **Penetrazione Magica:** {{ d(spell_penetration_bonus) }}  \n- **CD per Scuola:** {{ d(dc_per_school) }}\n\n---\n\n## Routine di Round (rapida)\n1) **Buff chiave:** {{ d(buffs_open) }}  \n2) **Posizionamento:** {{ d(movement_plan) }}  \n3) **Output:** {{ d(attack_plan) }}  \n**Priorit√† reattive:** {{ d(reactions_list, 'Step laterale; AoO; Immediate') }}\n\n---\n\n## Risorse Giornaliere\n| Risorsa | Max | Usate | Rimaste | Reset |\n|---|---:|---:|---:|---|\n{% set risorse = risorse_giornaliere or [] %}\n{% if risorse %}\n{% for r in risorse -%}\n| {{ d(r.nome) }} | {{ d(r.max) }} | {{ d(r.usate,0) }} | {{ (r.max|default(0)) - (r.usate|default(0)) }} | {{ d(r.reset,'giornaliero') }} |\n{%- endfor %}\n{% else %}\n| Rage / Ki / Panache / Grit / Arcane Pool / Performance | {{ d(res_max) }} | {{ d(res_used,0) }} | {{ (res_max|default(0)) - (res_used|default(0)) }} | {{ d(res_reset,'giornaliero') }} |\n{% endif %}\n\n---\n\n## Consumabili\n- **Pozioni:** {{ d(consum_potions) }}  \n- **Pergamene:** {{ d(consum_scrolls) }}  \n- **Bacchette (cariche):** {{ d(consum_wands) }}\n\n---\n\n## WBL & Shopping\n- **Budget attuale:** {{ gp|default(0) }} gp | **Breakpoint prossimo:** {{ d(next_wbl_gp) }} gp\n- **Priorit√† acquisti:** {{ d(buylist_priority) }}\n\n---\n\n## Equipaggiamento\n- {{ (equipaggiamento or []) | join(', ') if equipaggiamento else '‚Äî' }}\n- **Armi/Armature/Oggetti:** {{ d(equip_base) }}  \n- **Peso totale trasportato:** {{ d(peso_totale) }}  \n- **Capacit√† di trasporto:** L {{ d(carico_leggero) }} / M {{ d(carico_medio) }} / P {{ d(carico_pesante) }}  \n- **Valute:** Rame {{ cp|default(0) }} ‚Ä¢ Argento {{ sp|default(0) }} ‚Ä¢ Oro {{ gp|default(0) }} ‚Ä¢ Platino {{ pp|default(0) }}\n\n---\n\n## Lingue & Varie\n- **Lingue:** {{ (lingue or []) | join(', ') if lingue else '‚Äî' }}  \n- **Punti Eroe (opz.):** {{ d(hero_points) }}  \n- **Altre note:** {{ d(note_varie) }}\n\n---\n\n## Companion / Famigli\n{{ d(companion) }}\n\n---\n\n## Psicologia & Roleplay\n- **Sinergie**: {{ j(sinergie, ', ') or d(roleplay_sinergie) }}\n- **Teoria dominante**: {{ d(teoria_dominante, 'Jung/OCEAN/Enneagramma') }}\n- **Comportamento prevalente**: {{ d(comportamento_prevalente, 'es. introverso, impulsivo, empatico') }}\n- **Stile decisionale**: {{ d(stile_decisionale, 'es. segue l‚Äôistinto, valuta i rischi, ecc.') }}\n- **Motto/Frase tipica/Modi di dire/Accento**: {{ d(motto_o_frase, 'es. accento locale, intercalare ricorrente') }}\n- **Spunti per interpretazione**: {{ d(spunti_interpretativi, 'es. parla per enigmi, ama raccontare storie') }}\n- **Background Narrativo**: {{ d(background_narrativo, 'breve backstory coerente con razza, classe e tratti') }}\n\n---\n\n{# ========== LIBRO MASTRO DELL‚ÄôAVVENTURIERO (LEDGER) ========== #}\n{% if SHOW_LEDGER %}\n## üí∞ Adventurer Ledger ‚Äî KPI & Movimenti\n{% set cur_pp = (currency.pp if currency is defined else pp) | default(0) %}\n{% set cur_gp = (currency.gp if currency is defined else gp) | default(0) %}\n{% set cur_sp = (currency.sp if currency is defined else sp) | default(0) %}\n{% set cur_cp = (currency.cp if currency is defined else cp) | default(0) %}\n{% set gp_liquidi = to_gp(cur_pp,cur_gp,cur_sp,cur_cp) %}\n{% set gp_investiti = ledger_invested_gp | default(0) %}\n{% set gp_totali = gp_liquidi + gp_investiti %}\n{% set wbl_target_gp = wbl_target_gp | default(next_wbl_gp | default(0)) %}\n{% set wbl_delta_gp = (gp_totali - (wbl_target_gp|float)) %}\n\n- **Cassa (liquidi):** {{ coin_str(cur_pp,cur_gp,cur_sp,cur_cp) }} = **{{ fmt_gp(gp_liquidi) }}**  \n- **Valore investito (gear):** **{{ fmt_gp(gp_investiti) }}** ¬∑ **Wealth totale:** **{{ fmt_gp(gp_totali) }}**  \n- **WBL target (liv {{ get_total_level(CL)|default(1) }}):** {{ fmt_gp(wbl_target_gp) }} ¬∑ **Œî vs WBL:** {{ signed((wbl_delta_gp)|round(1)) }} gp  \n- **Encumbrance hint:** {{ d(ledger_encumbrance_hint, 'ok') }}\n\n### Movimenti (ultimi / sessione)\n| Data | Tipo | Oggetto/Voce | Q.t√† | Val. unit | Totale | Œî GP | Fonte (AP/SX) | PFS |\n|---|---|---|---:|---:|---:|---:|---|:--:|\n{% for m in (ledger_movimenti or []) -%}\n| {{ d(m.data) }} | {{ d(m.tipo) }} | {{ d(m.oggetto) }} | {{ d(m.qty,1) }} | {{ d(m.vu) }} | {{ d(m.tot) }} | {{ d(m.delta_gp) }} | {{ d(m.source) }} | {{ '‚úì' if m.pfs else '' }} |\n{%- endfor %}\n{% if (ledger_movimenti or [])|length == 0 %}_Nessun movimento registrato._{% endif %}\n\n### Loot Parcels (non ancora liquidati)\n| Parcella | Stima gp | Assegnatario | Note |\n|---|---:|---|---|\n{% for p in (ledger_parcels or []) -%}\n| {{ d(p.nome) }} | {{ d(p.val_gp) }} | {{ d(p.assegnatario) }} | {{ d(p.note) }} |\n{%- endfor %}\n{% if (ledger_parcels or [])|length == 0 %}_Nessun loot in attesa._{% endif %}\n\n### Coda Crafting\n| Item | DC | Giorni | Costo materie | Risparmio | Stato |\n|---|---:|---:|---:|---:|---|\n{% for c in (ledger_crafting or []) -%}\n| {{ d(c.item) }} | {{ d(c.dc) }} | {{ d(c.days) }} | {{ d(c.cost) }} | {{ d(c.saving) }} | {{ d(c.status,'open') }} |\n{%- endfor %}\n{% if (ledger_crafting or [])|length == 0 %}_Nessun crafting pianificato._{% endif %}\n\n### Audit & PFS\n- **Flag non PFS-legal:** {{ d(ledger_pfs_flags, '‚Äî') }}\n- **Note GM/Audit:** {{ d(ledger_audit_notes, '‚Äî') }}\n\n{% endif %}\n\n{% if not PRINT_MODE and SHOW_VTT %}\n---\n## Hook VTT / Export\n- **Map ID:** {{ d(map_id) }} | **Bundle asset:** {{ d(vtt_bundle_path) }}\n- **Preset luci:** {{ d(vtt_light, 'day') }} | **Token scale:** {{ d(token_scale_hint, 'M') }}\n- **Grid consigliata:** {{ d(recommended_grid_size) }} | **Safe/Bleed:** {{ d(safe_area_pct, 5) }}% / {{ d(bleed_pct, 2) }}%\n- **Note GM:** {{ d(vtt_gm_notes) }}  <!-- 2‚Äì3 POI, percorsi, consigli Foundry/Roll20 -->\n- **Formati supportati:** Markdown strutturato, JSON ledger/vtt_json, blocchi compatibili con VTT.\n- **Note localizzazione numerica:** separatore {{ ',' if DECIMAL_COMMA else '.' }}, unit√† in gp.\n- **CTA export:** /export_pg_sheet ‚Ä¢ /export_pg_sheet_json\n{% endif %}\n\n---\n\n{# ========== SEZIONE DIDATTICA INTEGRATA (EXPLAIN) ========== #}\n{% if not PRINT_MODE and SHOW_EXPLAIN %}\n---\n## Explain ‚Äì Regola & Procedura (multi‚Äëmetodo)\n- **Regola (in una riga):** {{ d(explain.tldr) }}\n- **Contesto & Scopo:** {{ d(explain.context) }}\n\n### Procedura passo‚Äëpasso\n{{ d(explain.step_by_step) }}\n\n### Metodo 2 ‚Äì Algoritmico / Flow\n{{ d(explain.algorithmic) }}\n\n### Metodo 3 ‚Äì Analogia / Metafora\n{{ d(explain.analogy) }}\n\n### Errori comuni (e come evitarli)\n{{ d(explain.common_mistakes) }}\n\n### RAW vs RAI (edge cases)\n{{ d(explain.raw_vs_rai) }}\n\n### Esempio numerico rapido\n{{ d(explain.numeric_example) }}\n\n### Verifica / Quiz lampo (3 domande)\n{{ d(explain.quick_quiz) }}\n\n### Checklist di applicazione al tavolo\n- {{ d(explain.checklist) }}\n\n### Fonti didattiche (puntuali)\n- {{ d(explain.sources) }}  {# es. AoN ‚Üí CRB p.X; FAQ Paizo (link), blog dev #}\n{% endif %}\n\n{# ========== TECNICO/ANALISI (toggle) ========== #}\n{% if not PRINT_MODE and SHOW_MINMAX %}\n---\n## Analisi MinMax\n- **DPR medio (base/nova):** {{ d(STK.DPR_Base) }} / {{ d(STK.DPR_Nova) }}\n- **Sostenibilit√† difensiva:** {{ d(BM.Defense_status) }} {{ (BM.Defense_delta ~ '%') if BM.Defense_delta is not none else '' }}\n- **Meta Tier:** {{ d(BM.meta_tier, STK.meta_tier) }}\n\n**Benchmark (auto) ‚Äî Ref: {{ d(benchmark_reference_label, FIRST_CLASS) }}**\n| Parametro | Stato | Œî vs Ref |\n|---|---:|---:|\n| DPR 1‚Äì3 | {{ d(BM.DPR_early_status) }} | {{ BM.DPR_early_delta if BM.DPR_early_delta is not none else '‚Äî' }}% |\n| DPR 4+  | {{ d(BM.DPR_late_status)  }} | {{ BM.DPR_late_delta  if BM.DPR_late_delta  is not none else '‚Äî' }}% |\n| Difesa  | {{ d(BM.Defense_status)   }} | {{ BM.Defense_delta   if BM.Defense_delta   is not none else '‚Äî' }}% |\n| Buff    | {{ d(BM.Buff_status) }} | ‚Äì |\n| Azioni  | {{ d(BM.Actions_status) }} | ‚Äì |\n| Scaling | {{ d(BM.Scaling_status) }} | ‚Äì |\n\nüî• **Risk Heatmap (‚â•2):** Feat ‚Üí {{ j(BM.risk_top3.feats) }} ¬∑ Spell ‚Üí {{ j(BM.risk_top3.spells) }}  \nüè∑ **Origine suggerimenti:** {{ source_mix_summary() }}\n{% if benchmark_comparison %}\n---\n## Benchmark Comparativo\n**Riferimento:** {{ benchmark_comparison.reference_label }} ({{ 'Auto' if benchmark_comparison.auto else 'Manuale' }}){% if benchmark_comparison.timestamp %} ‚Äî {{ benchmark_comparison.timestamp }}{% endif %}\n| Categoria | Stato | Œî % |\n|---|---|---:|\n{% for k,v in benchmark_comparison.comparison.items() -%}\n| {{ k }} | {{ v.status }} | {{ v.diff }} |\n{%- endfor %}\n{% endif %}\n\n{% if not PRINT_MODE and SHOW_QA %}\n---\n## QA rapido\n- **Tabelle popolate?:** armi/skill/incantesimi non vuote o placeholder indicato.\n- **Valute normalizzate:** {{ coin_str(pp, gp, sp, cp) }} (usa fmt_gp per export).\n- **Coerenza WBL:** Œî vs target {{ d(wbl_delta_gp) }} gp; vendite/acquisti loggati nel ledger.\n- **Badge/Lingua:** tag PFS/RAW se noti; lingua coerente con prompt.\n{% endif %}\n\n---\n## Output checklist (inserire nel render finale)\n- Header con toggle attivi (MINMAX/VTT/QA/EXPLAIN/LEDGER) e lingua.\n- Fonti/tag: RAW/PFS/HR/META e richiami al Ledger/Explain/MinMax usati.\n- Struttura minima: sommario PG, blocchi statistici, economia (ledger/WBL), eventuale sezione Explain/MinMax.\n- Dati numerici formattati con {{ ',' if DECIMAL_COMMA else '.' }} come separatore decimale e unit√† gp/%. \n- Sezioni vuote: sostituire con placeholder espliciti per evitare header orfani.\n{% endif %}\n\n{% if not PRINT_MODE %}\n---\n## Suggerimenti interpretativi\n- {{ d(spunti_interpretativi) }}\n{% endif %}\n\n---\n> üìé Fonti Meta (badge sintetico): {{ lookup_meta_badges('any') or '‚Äî' }}\n\n---\n## Profilo ruolistico (‚Äúalla Locanda‚Äù)\n- **Modello psicologico:** {{ d(modello_psico) }} (es. Jung/OCEAN/Enneagramma)  \n- **Stile decisionale:** {{ d(stile_decisionale) }}  \n- **Storia personale (perch√© in avventura):** {{ d(storia_personale) }}  \n- **Relazioni & legami:** {{ d(relazioni_legami) }} *(un PNG caro, una rivalit√†, un giuramento)*  \n- **Ganci di campagna:** {{ d(ganci_campagna) }} *(per restare nel party)*  \n- **Flavor RP:** {{ d(flavor_rp) }} *(tic, frasi tipiche, feticci/ricordi)*\n\n---\n## Canone & Fonti\n- **Edizione di riferimento:** PF1e  \n- **Fonti primarie (üìó):** {{ d(fonti_primarie) }}  \n- **Secondarie (üîé):** {{ d(fonti_secondarie) }}  \n- **Varianti PFS-Lore (üß≠):** {{ d(pfs_varianti) }}  \n- **Dev Insight (üß™):** {{ d(dev_insight) }}  \n- **House Lore (‚ùó):** {{ d(house_lore_note) }}  \n- **Citazioni brevi (‚â§25 parole):**\n{% for c in (citazioni_brevi or []) -%}\n- ‚Äú{{ c.estratto }}‚Äù ‚Äî {{ c.fonte }}{{ ' ' ~ c.pagina_opz if c.pagina_opz else '' }}\n{%- endfor %}\n\n---\n## Collegamenti di Campagna\n- **SX00 (dashboard):** {{ d(sx00_link) }}\n- **AV corrente:** {{ d(av_code) }} | **SX correlate:** {{ d(sx_codes) }}\n- **Fazioni (NC) collegate:** {{ d(fazioni_collegate) }}\n- **Thread aperti / milestone:** {{ d(thread_aperti) }}\n{% if not PRINT_MODE and SHOW_QA %}\n---\n## QA & Spoiler\n- **spoiler_mode:** {{ d(spoiler_mode, 'light') }}  \n- **AP warning:** {{ d(ap_warning) }}  \n- **Confidence:** {{ d(confidence_score) }} | **Uncertainty flags:** {{ d(uncertainty_flags) }}\n\n{% if glossario_golarion %}\n---\n## Glossario Golarion (rapido)\n{% for g in glossario_golarion.termini or [] -%}\n- **{{ g.termine }}**: {{ g.def }}\n{%- endfor %}\n{% endif %}\n\n---\n## Canone & Fonti META\n- **Fonti (RAW/PFS se presenti):** {{ (fonti or []) | join(', ') if fonti else '‚Äî' }}\n- **Fonti META (ord. autorit√†):** {% for f in (fonti_meta or []) %}{{ f.badge }} [{{ f.tipo }}]({{ f.link }}){% if not loop.last %} ¬∑ {% endif %}{% endfor %}\n\n---\n## Regole & QA\n- **Regole attive:** {{ rules_status_text() }}  \n- **QA export gate:** Core={{ 'OK' if validate_core_ok else '‚Äî' }}, Feats={{ 'OK' if validate_feats_ok else '‚Äî' }}, Sim={{ 'OK' if simulate_ok else '‚Äî' }}\n{% endif %}\n\n"
      },
      "velocita": 0,
      "iniziativa": 0,
      "pf_totali": 0,
      "skill_points": 0,
      "sheet_markdown": "### üßô Scheda Personaggio in Markdown\n\n---\n\n\n\n\n\n\n\n  \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n# ‚Äî ‚Äî Liv. 1 (‚Äî ¬∑ Psychic (1) ‚Äî Base)\n\n**Allineamento:**   \n**Divinit√†:**   \n**Taglia:**  | **Et√†:**  | **Sesso:**  | **Altezza/Peso:**  /   \n**Ruolo consigliato:**   \n**Stile interpretativo:**  ‚Äî ‚Äî  \n**Background breve (5‚Äì10 righe):** \n\n---\n\n## Statistiche fondamentali\n- **For** 10 (mod 0)\n- **Des** 10 (mod 0)\n- **Cos** 10 (mod 0)\n- **Int** 10 (mod 0)\n- **Sag** 10 (mod 0)\n- **Car** 10 (mod 0)\n\n- **PF (HP):**  | **CA:**   \n- **CA (breakdown):** 17 = 10 + Arm 0 + Scudo 0 + Des 0 + Defl 0 + Nat 0 + Dodge 0 + Altro 0  \n- **CA Var.:** Contatto 10 ¬∑ Colto alla sprovvista 10  \n- **Tiri Salvezza:** Temp 0 / Riflessi 0 / Volont√† 0  \n- **BAB:** 0 | **Iniziativa:** 0 | **Velocit√†:** 0  \n- **CMB/CMD:** 0 / 0  \n\n\n- **CMD (dettaglio):** 0 = 10 + BAB 0 + For/Des 0 + Des 0 + Taglia 0 + Altro 0\n\n- **PE (XP):**  / \n\n---\n\n## Difese Speciali\n- **RD/Res/Imm:**   \n- **RS:**  | **Guarigione rapida/Rigenerazione:**   \n- **Sensi:**  | **Percezione (tot):** \n\n---\n\n## Combattimento\n### Armi e attacchi\n| Arma | Tipo | Attacco | Danni | Critico | Portata | Note |\n|---|---|---:|---|---|---|---|\n\n_(Nessuna arma strutturata: derivabile da `equipaggiamento` o aggiungerla qui.)_\n\n- **Attacchi naturali:**   \n- **Capacit√† speciali:** \n\n### Manovre CMB\n| Manovra | Bonus |\n|---|---:|\n| Disarm |  |\n| Trip   |  |\n| Grapple|  |\n| Bull Rush |  |\n| Sunder |  |\n\n---\n\n## Economia d‚ÄôAzione\n- **AoO/round:**   \n- **Swift usata?:**   \n- **Immediate pronte?:** \n\n---\n\n## Armatura (tecnica)\n- **ACP:**  | **Max Des:**  | **ASF:** % | **Velocit√† ridotta:** \n\n---\n\n## Abilit√† (Skills)\n| Abilit√† | Gradi | Mod Car | Var | Classe? | Totale |\n|---|---:|---:|---:|:--:|---:|\n\n_Nessuna abilit√† strutturata._\n\n---\n\n## Talenti, Tratti & Difetti\n- **Talenti:** ‚Äî\n- **Tratti:** ‚Äî\n- **Difetti:** \n\n---\n\n## Poteri di Classe / Archetipi\n\n\n**Usi/giorno chiave:** \n\n---\n\n## Incantesimi / Capacit√† Magiche\n- **Classe da incantatore:**   \n- **CD base incantesimi:**  | **LI:**   \n- **Slot per giorno:** \n\n**Conosciuti/Preparati**\n\n_Nessun incantesimo conosciuto o preparato specificato._\n\n\n_Nessuna tabella incantesimi disponibile._\n\n\n### Incantatore (tecnico)\n\n- **Concentrazione:** \n\n- **Penetrazione Magica:**   \n- **CD per Scuola:** \n\n---\n\n## Routine di Round (rapida)\n1) **Buff chiave:**   \n2) **Posizionamento:**   \n3) **Output:**   \n**Priorit√† reattive:** \n\n---\n\n## Risorse Giornaliere\n| Risorsa | Max | Usate | Rimaste | Reset |\n|---|---:|---:|---:|---|\n\n\n| Rage / Ki / Panache / Grit / Arcane Pool / Performance |  |  | 0 |  |\n\n\n---\n\n## Consumabili\n- **Pozioni:**   \n- **Pergamene:**   \n- **Bacchette (cariche):** \n\n---\n\n## WBL & Shopping\n- **Budget attuale:** 0 gp | **Breakpoint prossimo:** 0 gp\n- **Priorit√† acquisti:** \n\n---\n\n## Equipaggiamento\n- ‚Äî\n- **Armi/Armature/Oggetti:**   \n- **Peso totale trasportato:**   \n- **Capacit√† di trasporto:** L  / M  / P   \n- **Valute:** Rame 0 ‚Ä¢ Argento 0 ‚Ä¢ Oro 0 ‚Ä¢ Platino 0\n\n---\n\n## Lingue & Varie\n- **Lingue:** ‚Äî  \n- **Punti Eroe (opz.):**   \n- **Altre note:** \n\n---\n\n## Companion / Famigli\n\n\n---\n\n## Psicologia & Roleplay\n- **Sinergie**: \n- **Teoria dominante**: \n- **Comportamento prevalente**: \n- **Stile decisionale**: \n- **Motto/Frase tipica/Modi di dire/Accento**: \n- **Spunti per interpretazione**: \n- **Background Narrativo**: \n\n---\n\n\n\n## üí∞ Adventurer Ledger ‚Äî KPI & Movimenti\n\n\n\n\n\n\n\n\n\n\n- **Cassa (liquidi):** PP 0 ‚Ä¢ GP 0 ‚Ä¢ SP 0 ‚Ä¢ CP 0 = **0 gp**  \n- **Valore investito (gear):** **0 gp** ¬∑ **Wealth totale:** **0 gp**  \n- **WBL target (liv 1):** 0 gp ¬∑ **Œî vs WBL:** 0.0 gp  \n- **Encumbrance hint:** \n\n### Movimenti (ultimi / sessione)\n| Data | Tipo | Oggetto/Voce | Q.t√† | Val. unit | Totale | Œî GP | Fonte (AP/SX) | PFS |\n|---|---|---|---:|---:|---:|---:|---|:--:|\n\n_Nessun movimento registrato._\n\n### Loot Parcels (non ancora liquidati)\n| Parcella | Stima gp | Assegnatario | Note |\n|---|---:|---|---|\n\n_Nessun loot in attesa._\n\n### Coda Crafting\n| Item | DC | Giorni | Costo materie | Risparmio | Stato |\n|---|---:|---:|---:|---:|---|\n\n_Nessun crafting pianificato._\n\n### Audit & PFS\n- **Flag non PFS-legal:** \n- **Note GM/Audit:** \n\n\n\n\n---\n## Hook VTT / Export\n- **Map ID:**  | **Bundle asset:** \n- **Preset luci:**  | **Token scale:** \n- **Grid consigliata:**  | **Safe/Bleed:** % / %\n- **Note GM:**   <!-- 2‚Äì3 POI, percorsi, consigli Foundry/Roll20 -->\n- **Formati supportati:** Markdown strutturato, JSON ledger/vtt_json, blocchi compatibili con VTT.\n- **Note localizzazione numerica:** separatore ,, unit√† in gp.\n- **CTA export:** /export_pg_sheet ‚Ä¢ /export_pg_sheet_json\n\n\n---\n\n\n\n---\n## Explain ‚Äì Regola & Procedura (multi‚Äëmetodo)\n- **Regola (in una riga):** \n- **Contesto & Scopo:** \n\n### Procedura passo‚Äëpasso\n\n\n### Metodo 2 ‚Äì Algoritmico / Flow\n\n\n### Metodo 3 ‚Äì Analogia / Metafora\n\n\n### Errori comuni (e come evitarli)\n\n\n### RAW vs RAI (edge cases)\n\n\n### Esempio numerico rapido\n\n\n### Verifica / Quiz lampo (3 domande)\n\n\n### Checklist di applicazione al tavolo\n- \n\n### Fonti didattiche (puntuali)\n-   \n\n\n\n\n---\n## Analisi MinMax\n- **DPR medio (base/nova):**  / \n- **Sostenibilit√† difensiva:**  %\n- **Meta Tier:** T3\n\n**Benchmark (auto) ‚Äî Ref: **\n| Parametro | Stato | Œî vs Ref |\n|---|---:|---:|\n| DPR 1‚Äì3 |  | % |\n| DPR 4+  |  | % |\n| Difesa  |  | % |\n| Buff    |  | ‚Äì |\n| Azioni  |  | ‚Äì |\n| Scaling |  | ‚Äì |\n\nüî• **Risk Heatmap (‚â•2):** Feat ‚Üí  ¬∑ Spell ‚Üí   \nüè∑ **Origine suggerimenti:** None\n\n\n\n---\n## QA rapido\n- **Tabelle popolate?:** armi/skill/incantesimi non vuote o placeholder indicato.\n- **Valute normalizzate:** PP 0 ‚Ä¢ GP 0 ‚Ä¢ SP 0 ‚Ä¢ CP 0 (usa fmt_gp per export).\n- **Coerenza WBL:** Œî vs target 0.0 gp; vendite/acquisti loggati nel ledger.\n- **Badge/Lingua:** tag PFS/RAW se noti; lingua coerente con prompt.\n\n\n---\n## Output checklist (inserire nel render finale)\n- Header con toggle attivi (MINMAX/VTT/QA/EXPLAIN/LEDGER) e lingua.\n- Fonti/tag: RAW/PFS/HR/META e richiami al Ledger/Explain/MinMax usati.\n- Struttura minima: sommario PG, blocchi statistici, economia (ledger/WBL), eventuale sezione Explain/MinMax.\n- Dati numerici formattati con , come separatore decimale e unit√† gp/%. \n- Sezioni vuote: sostituire con placeholder espliciti per evitare header orfani.\n\n\n\n---\n## Suggerimenti interpretativi\n- \n\n\n---\n> üìé Fonti Meta (badge sintetico): ‚Äî\n\n---\n## Profilo ruolistico (‚Äúalla Locanda‚Äù)\n- **Modello psicologico:**  (es. Jung/OCEAN/Enneagramma)  \n- **Stile decisionale:**   \n- **Storia personale (perch√© in avventura):**   \n- **Relazioni & legami:**  *(un PNG caro, una rivalit√†, un giuramento)*  \n- **Ganci di campagna:**  *(per restare nel party)*  \n- **Flavor RP:**  *(tic, frasi tipiche, feticci/ricordi)*\n\n---\n## Canone & Fonti\n- **Edizione di riferimento:** PF1e  \n- **Fonti primarie (üìó):**   \n- **Secondarie (üîé):**   \n- **Varianti PFS-Lore (üß≠):**   \n- **Dev Insight (üß™):**   \n- **House Lore (‚ùó):**   \n- **Citazioni brevi (‚â§25 parole):**\n\n\n---\n## Collegamenti di Campagna\n- **SX00 (dashboard):** \n- **AV corrente:**  | **SX correlate:** \n- **Fazioni (NC) collegate:** \n- **Thread aperti / milestone:** \n\n---\n## QA & Spoiler\n- **spoiler_mode:**   \n- **AP warning:**   \n- **Confidence:**  | **Uncertainty flags:** \n\n\n\n---\n## Canone & Fonti META\n- **Fonti (RAW/PFS se presenti):** ‚Äî\n- **Fonti META (ord. autorit√†):** \n\n---\n## Regole & QA\n- **Regole attive:** None  \n- **QA export gate:** Core=‚Äî, Feats=‚Äî, Sim=‚Äî\n\n",
      "salvezze_breakdown": {
        "Tempra": {
          "totale": 0,
          "base": 0,
          "modificatore": 0,
          "misc": 0
        },
        "Riflessi": {
          "totale": 0,
          "base": 0,
          "modificatore": 0,
          "misc": 0
        },
        "Volont√†": {
          "totale": 0,
          "base": 0,
          "modificatore": 0,
          "misc": 0
        },
        "tempra": {
          "totale": 0,
          "base": 0,
          "modificatore": 0,
          "misc": 0
        },
        "riflessi": {
          "totale": 0,
          "base": 0,
          "modificatore": 0,
          "misc": 0
        },
        "volonta": {
          "totale": 0,
          "base": 0,
          "modificatore": 0,
          "misc": 0
        }
      },
      "BAB": 0,
      "init": 0,
      "speed": 0,
      "fonti": [
        "http://localhost:8000/modules/minmax_builder.txt?mode=extended&class=Psychic&stub=true&race=Human"
      ],
      "skills_map": {},
      "skills": [],
      "spell_levels": [],
      "magia": {},
      "lingue": [],
      "sensi": [],
      "condizioni": [],
      "equipaggiamento": [],
      "inventario": [],
      "talenti": [],
      "capacita_classe": [],
      "progressione": []
    }
  },
  "narrative": "Human Base pronta/o per il campo, specializzata/o in tattiche da Psychic.",
  "sheet": {
    "classi": [
      {
        "nome": "Psychic",
        "livelli": 1,
        "archetipi": [
          "Base"
        ]
      }
    ],
    "statistiche": {
      "FOR": 16,
      "DES": 14,
      "COS": 14,
      "INT": 10,
      "SAG": 12,
      "CAR": 8
    },
    "statistiche_chiave": {
      "attacco": "+4",
      "danni": "1d8+3",
      "ca": 17
    },
    "benchmarks": {
      "meta_tier": "T3"
    },
    "hooks": null
  },
  "ledger": {
    "movimenti": [
      {
        "voce": "Equipaggiamento iniziale",
        "importo": -150
      },
      {
        "voce": "Ricompensa missione",
        "importo": 250
      }
    ],
    "currency": {
      "oro": 100,
      "argento": 25,
      "rame": 40
    }
  },
  "class": "Psychic",
  "mode": "extended",
  "composite": {
    "build": {
      "build_state": {
        "class": "Psychic",
        "mode": "extended",
        "race": "Human",
        "archetype": "Base",
        "step": 1,
        "step_total": 16,
        "step_labels": {
          "1": "Profilo Base",
          "2": "Razza & Classe",
          "3": "Archetipi & Multiclasse",
          "4": "Feats & Talenti",
          "5": "Spell & Power Set",
          "6": "Equip & Risorse",
          "7": "Benchmark & Simulazioni",
          "8": "QA & Export",
          "9": "Dummies Sheet",
          "10": "Esportazione",
          "11": "Fork/Varianti",
          "12": "Comparativa",
          "13": "Meta Rating",
          "14": "Companion",
          "15": "Report",
          "16": "Chiusura"
        },
        "statistics": {
          "FOR": 16,
          "DES": 14,
          "COS": 14,
          "INT": 10,
          "SAG": 12,
          "CAR": 8
        }
      },
      "benchmark": {
        "meta_tier": "T3",
        "ruling_badge": "validated",
        "dpr_snapshot": {
          "livello_1": {
            "media": 6,
            "picco": 9
          },
          "livello_5": {
            "media": 18,
            "picco": 26
          }
        },
        "statistics": {
          "attacco": "+4",
          "danni": "1d8+3",
          "ca": 17
        }
      },
      "export": {
        "sheet_payload": {
          "classi": [
            {
              "nome": "Psychic",
              "livelli": 1,
              "archetipi": [
                "Base"
              ]
            }
          ],
          "statistiche": {
            "FOR": 16,
            "DES": 14,
            "COS": 14,
            "INT": 10,
            "SAG": 12,
            "CAR": 8
          },
          "statistiche_chiave": {
            "attacco": "+4",
            "danni": "1d8+3",
            "ca": 17
          },
          "benchmarks": {
            "meta_tier": "T3"
          },
          "salvezze": {
            "Tempra": 0,
            "Riflessi": 0,
            "Volont√†": 0,
            "tempra": 0,
            "riflessi": 0,
            "volonta": 0
          },
          "ledger": {
            "movimenti": [
              {
                "voce": "Equipaggiamento iniziale",
                "importo": -150
              },
              {
                "voce": "Ricompensa missione",
                "importo": 250
              }
            ],
            "currency": {
              "oro": 100,
              "argento": 25,
              "rame": 40
            }
          },
          "print_mode": false,
          "show_minmax": true,
          "show_vtt": true,
          "show_qa": true,
          "show_explain": true,
          "show_ledger": true,
          "decimal_comma": true,
          "AC_arm": 0,
          "AC_scudo": 0,
          "AC_des": 0,
          "AC_defl": 0,
          "AC_nat": 0,
          "AC_dodge": 0,
          "AC_misc": 0,
          "AC_base": 10,
          "AC_tot": 17,
          "CA_touch": 10,
          "CA_ff": 10,
          "modules": {
            "scheda_pg_markdown_template.md": "### üßô Scheda Personaggio in Markdown\n\n---\n\n{# ========== SETUP & MACROS ========== #}\n{% set PRINT_MODE    = print_mode    | default(false) %}\n{% set SHOW_MINMAX   = show_minmax   | default(true)  %}\n{% set SHOW_VTT      = show_vtt      | default(true)  %}\n{% set SHOW_QA       = show_qa       | default(true)  %}\n{% set SHOW_EXPLAIN  = show_explain  | default(true)  %}\n{% set SHOW_LEDGER   = show_ledger   | default(true)  %}  {# <-- nuovo: Libro Mastro #}\n{% set DECIMAL_COMMA = decimal_comma | default(true)  %}\n\n{% macro d(val, fallback='‚Äî') -%}{{ (val if (val is not none and val != '') else fallback) }}{%- endmacro %}\n{% macro mod(x) -%}{{ (((x|default(10))|int) - 10) // 2 }}{%- endmacro %}\n{% macro j(list, sep=', ') -%}{{ (list or []) | select('string') | list | join(sep) }}{%- endmacro %}\n{% macro signed(x) -%}{% if x is not none %}{{ \"+\" if x>=0 else \"\" }}{{ x }}{% else %}‚Äî{% endif %}{%- endmacro %}\n\n{# --- Monete / Valorizzazioni (per Adventurer Ledger) --- #}\n{% macro to_gp(pp=0,gp=0,sp=0,cp=0) -%}{{ (pp|float)*10 + (gp|float) + (sp|float)/10 + (cp|float)/100 }}{%- endmacro %}\n{% macro coin_str(pp=0,gp=0,sp=0,cp=0) -%}\nPP {{pp|default(0)}} ‚Ä¢ GP {{gp|default(0)}} ‚Ä¢ SP {{sp|default(0)}} ‚Ä¢ CP {{cp|default(0)}}\n{%- endmacro %}\n{% macro fmt_gp(x) -%}\n{%- set raw = ('{:.2f}'.format(x|float)).rstrip('0').rstrip('.') -%}\n{{ (raw.replace('.', ',') if DECIMAL_COMMA else raw) }} gp\n{%- endmacro %}\n\n{% set ST  = statistiche or {} %}\n{% set STK = statistiche_chiave or {} %}\n{% set SAL = salvezze or {} %}\n{% set BM  = benchmarks or {} %}\n\n{% set CL = classi or [] %}\n{% set FIRST_CLASS = (CL[0].nome if CL and CL|length>0 else '‚Äî') %}\n\n{# ----- CA: dodge separato + ricostruzione ----- #}\n{% set AC_arm   = AC_arm   | default(0) %}\n{% set AC_scudo = AC_scudo | default(0) %}\n{% set AC_des   = AC_des   | default(0) %}\n{% set AC_defl  = AC_defl  | default(0) %}\n{% set AC_nat   = AC_nat   | default(0) %}\n{% set AC_dodge = AC_dodge | default(0) %}\n{% set AC_misc  = AC_misc  | default(AC_altro | default(0)) %}\n\n{% set AC_tot = AC_tot if (AC_tot is not none)\n  else (10 + AC_arm + AC_scudo + AC_des + AC_defl + AC_nat + AC_dodge + AC_misc) %}\n\n{% set CA_touch = 10 + AC_des + AC_defl + AC_dodge + AC_misc %}\n{% set CA_ff    = 10 + AC_arm + AC_scudo + AC_defl + AC_nat + AC_misc %}\n\n{# ----- Spell table: robust ----- #}\n{% set spell_levels    = spell_levels or [] %}\n{% set has_spell_table = (spell_levels|length) > 0 %}\n\n{# Hook Percezione auto se presente skills_map #}\n{% set skills_map = skills_map or {} %}\n{% if skills_map and skills_map.Percezione and skills_map.Percezione.totale is not none %}\n  {% set percezione_tot = skills_map.Percezione.totale %}\n{% endif %}\n\n# {{ nome | default('‚Äî') }} ‚Äî Liv. {{ get_total_level(CL)|default('‚Äî') }} ({{ razza | default('‚Äî') }} ¬∑ {% for c in CL %}{{ c.nome }} ({{ c.livelli }}){% if c.archetipi %} ‚Äî {{ c.archetipi | join(', ') }}{% endif %}{% if not loop.last %} / {% endif %}{% endfor %})\n\n**Allineamento:** {{ d(allineamento) }}  \n**Divinit√†:** {{ d(divinita) }}  \n**Taglia:** {{ d(taglia) }} | **Et√†:** {{ d(eta) }} | **Sesso:** {{ d(sesso) }} | **Altezza/Peso:** {{ d(altezza) }} / {{ d(peso) }}  \n**Ruolo consigliato:** {{ d(ruolo) }}  \n**Stile interpretativo:** {{ d(player_style) }} ‚Äî {{ d(style_hint(player_style)) }}  \n**Background breve (5‚Äì10 righe):** {{ d(background) }}\n\n---\n\n## Statistiche fondamentali\n- **For** {{ ST.Forza|default(10) }} (mod {{ mod(ST.Forza) }})\n- **Des** {{ ST.Destrezza|default(10) }} (mod {{ mod(ST.Destrezza) }})\n- **Cos** {{ ST.Costituzione|default(10) }} (mod {{ mod(ST.Costituzione) }})\n- **Int** {{ ST.Intelligenza|default(10) }} (mod {{ mod(ST.Intelligenza) }})\n- **Sag** {{ ST.Saggezza|default(10) }} (mod {{ mod(ST.Saggezza) }})\n- **Car** {{ ST.Carisma|default(10) }} (mod {{ mod(ST.Carisma) }})\n\n- **PF (HP):** {{ d(STK.PF) }} | **CA:** {{ d(STK.CA, AC_tot) }}  \n- **CA (breakdown):** {{ AC_tot }} = 10 + Arm {{ AC_arm }} + Scudo {{ AC_scudo }} + Des {{ AC_des }} + Defl {{ AC_defl }} + Nat {{ AC_nat }} + Dodge {{ AC_dodge }} + Altro {{ AC_misc }}  \n- **CA Var.:** Contatto {{ CA_touch }} ¬∑ Colto alla sprovvista {{ CA_ff }}  \n- **Tiri Salvezza:** Temp {{ d(SAL.Tempra) }} / Riflessi {{ d(SAL.Riflessi) }} / Volont√† {{ d(SAL.Volont√†) }}  \n- **BAB:** {{ d(BAB) }} | **Iniziativa:** {{ d(init) }} | **Velocit√†:** {{ d(speed) }}  \n- **CMB/CMD:** {{ d(CMB) }} / {{ d(CMD) }}  \n\n{% set CMD_base = 10 + (BAB|default(0)) + (mod(ST.Forza) if use_str_for_cmd|default(true) else mod(ST.Destrezza)) + mod(ST.Destrezza) + size_mod_cmd|default(0) + cmd_altro|default(0) %}\n- **CMD (dettaglio):** {{ CMD|default(CMD_base) }} = 10 + BAB {{ BAB|default(0) }} + For/Des {{ (mod(ST.Forza) if use_str_for_cmd|default(true) else mod(ST.Destrezza)) }} + Des {{ mod(ST.Destrezza) }} + Taglia {{ size_mod_cmd|default(0) }} + Altro {{ cmd_altro|default(0) }}\n\n- **PE (XP):** {{ d(xp_correnti) }} / {{ d(xp_prossimo_livello) }}\n\n---\n\n## Difese Speciali\n- **RD/Res/Imm:** {{ d(rd_res_imm) }}  \n- **RS:** {{ d(rs) }} | **Guarigione rapida/Rigenerazione:** {{ d(heal_regen) }}  \n- **Sensi:** {{ d(sensi) }} | **Percezione (tot):** {{ d(percezione_tot) }}\n\n---\n\n## Combattimento\n### Armi e attacchi\n| Arma | Tipo | Attacco | Danni | Critico | Portata | Note |\n|---|---|---:|---|---|---|---|\n{% for a in (armi or []) -%}\n| {{ d(a.nome) }} | {{ d(a.tipo) }} | {{ d(a.attacco) }} | {{ d(a.danni) }} | {{ d(a.critico) }} | {{ d(a.portata) }} | {{ a.note | default('') }} |\n{%- endfor %}\n{% if (armi or [])|length == 0 %}_(Nessuna arma strutturata: derivabile da `equipaggiamento` o aggiungerla qui.)_{% endif %}\n\n- **Attacchi naturali:** {{ d(attacchi_naturali) }}  \n- **Capacit√† speciali:** {{ d(capitolo_capacita, capacita_speciali) }}\n\n### Manovre CMB\n| Manovra | Bonus |\n|---|---:|\n| Disarm | {{ d(cmb_disarm) }} |\n| Trip   | {{ d(cmb_trip) }} |\n| Grapple| {{ d(cmb_grapple) }} |\n| Bull Rush | {{ d(cmb_bull_rush) }} |\n| Sunder | {{ d(cmb_sunder) }} |\n\n---\n\n## Economia d‚ÄôAzione\n- **AoO/round:** {{ d(aoo_per_round) }}  \n- **Swift usata?:** {{ d(swift_used,'no') }}  \n- **Immediate pronte?:** {{ d(immediate_ready,'s√¨') }}\n\n---\n\n## Armatura (tecnica)\n- **ACP:** {{ d(acp) }} | **Max Des:** {{ d(max_dex) }} | **ASF:** {{ d(asf_pct) }}% | **Velocit√† ridotta:** {{ d(speed_armor_penalty) }}\n\n---\n\n## Abilit√† (Skills)\n| Abilit√† | Gradi | Mod Car | Var | Classe? | Totale |\n|---|---:|---:|---:|:--:|---:|\n{% for s in (skills or []) -%}\n| {{ d(s.nome) }} | {{ s.gradi|default(0) }} | {{ signed(s.mod_car|default(0)) }} | {{ signed(s.var|default(0)) }} | {{ '‚úì' if s.classe else '' }} | {{ s.totale|default(s.gradi|default(0) + s.mod_car|default(0) + s.var|default(0) + (3 if s.classe else 0)) }} |\n{%- endfor %}\n{% if (skills or [])|length == 0 %}_Nessuna abilit√† strutturata._{% endif %}\n\n---\n\n## Talenti, Tratti & Difetti\n- **Talenti:** {% set feats = (progressione or []) | map(attribute='talento') | select('string') | reject('equalto', None) | list %}{{ j(feats) or '‚Äî' }}\n- **Tratti:** {% if tratti %}{% for t in tratti %}{{ d(t.nome) }}{{ ', ' if not loop.last }}{% endfor %}{% else %}‚Äî{% endif %}\n- **Difetti:** {{ d(difetti) }}\n\n---\n\n## Poteri di Classe / Archetipi\n{{ d(poteri_classe) }}\n\n**Usi/giorno chiave:** {{ d(usi_giorno_chiave) }}\n\n---\n\n## Incantesimi / Capacit√† Magiche\n- **Classe da incantatore:** {{ d(classe_incantatore, FIRST_CLASS) }}  \n- **CD base incantesimi:** {{ d(spell_dc_base) }} | **LI:** {{ d(livello_incantatore) }}  \n- **Slot per giorno:** {{ d(slot_incantesimi) }}\n\n**Conosciuti/Preparati**\n{% for lvl in (magia or {}).keys() | map('int') | list | sort %}\n- **{{ lvl }}¬∞:** {{ (magia[lvl] or []) | join(', ') }}\n{% endfor %}\n{% if (magia or {})|length == 0 %}_Nessun incantesimo conosciuto o preparato specificato._{% endif %}\n\n{% if has_spell_table %}\n| Liv | Conosciuti | Preparati | Slot/giorno | CD |\n|---:|---:|---:|---:|---:|\n{% for sl in spell_levels -%}\n| {{ sl.liv }} | {{ d(sl.known) }} | {{ d(sl.prepared) }} | {{ d(sl.per_day) }} | {{ d(sl.dc) }} |\n{%- endfor %}\n{% else %}\n_Nessuna tabella incantesimi disponibile._\n{% endif %}\n\n### Incantatore (tecnico)\n{% if concentration_bonus is not none %}\n- **Concentrazione:** {{ concentration_bonus }}\n{% else %}\n- **Concentrazione (hint):** LI {{ d(livello_incantatore,0) }} + mod stat chiave + vari\n{% endif %}\n- **Penetrazione Magica:** {{ d(spell_penetration_bonus) }}  \n- **CD per Scuola:** {{ d(dc_per_school) }}\n\n---\n\n## Routine di Round (rapida)\n1) **Buff chiave:** {{ d(buffs_open) }}  \n2) **Posizionamento:** {{ d(movement_plan) }}  \n3) **Output:** {{ d(attack_plan) }}  \n**Priorit√† reattive:** {{ d(reactions_list, 'Step laterale; AoO; Immediate') }}\n\n---\n\n## Risorse Giornaliere\n| Risorsa | Max | Usate | Rimaste | Reset |\n|---|---:|---:|---:|---|\n{% set risorse = risorse_giornaliere or [] %}\n{% if risorse %}\n{% for r in risorse -%}\n| {{ d(r.nome) }} | {{ d(r.max) }} | {{ d(r.usate,0) }} | {{ (r.max|default(0)) - (r.usate|default(0)) }} | {{ d(r.reset,'giornaliero') }} |\n{%- endfor %}\n{% else %}\n| Rage / Ki / Panache / Grit / Arcane Pool / Performance | {{ d(res_max) }} | {{ d(res_used,0) }} | {{ (res_max|default(0)) - (res_used|default(0)) }} | {{ d(res_reset,'giornaliero') }} |\n{% endif %}\n\n---\n\n## Consumabili\n- **Pozioni:** {{ d(consum_potions) }}  \n- **Pergamene:** {{ d(consum_scrolls) }}  \n- **Bacchette (cariche):** {{ d(consum_wands) }}\n\n---\n\n## WBL & Shopping\n- **Budget attuale:** {{ gp|default(0) }} gp | **Breakpoint prossimo:** {{ d(next_wbl_gp) }} gp\n- **Priorit√† acquisti:** {{ d(buylist_priority) }}\n\n---\n\n## Equipaggiamento\n- {{ (equipaggiamento or []) | join(', ') if equipaggiamento else '‚Äî' }}\n- **Armi/Armature/Oggetti:** {{ d(equip_base) }}  \n- **Peso totale trasportato:** {{ d(peso_totale) }}  \n- **Capacit√† di trasporto:** L {{ d(carico_leggero) }} / M {{ d(carico_medio) }} / P {{ d(carico_pesante) }}  \n- **Valute:** Rame {{ cp|default(0) }} ‚Ä¢ Argento {{ sp|default(0) }} ‚Ä¢ Oro {{ gp|default(0) }} ‚Ä¢ Platino {{ pp|default(0) }}\n\n---\n\n## Lingue & Varie\n- **Lingue:** {{ (lingue or []) | join(', ') if lingue else '‚Äî' }}  \n- **Punti Eroe (opz.):** {{ d(hero_points) }}  \n- **Altre note:** {{ d(note_varie) }}\n\n---\n\n## Companion / Famigli\n{{ d(companion) }}\n\n---\n\n## Psicologia & Roleplay\n- **Sinergie**: {{ j(sinergie, ', ') or d(roleplay_sinergie) }}\n- **Teoria dominante**: {{ d(teoria_dominante, 'Jung/OCEAN/Enneagramma') }}\n- **Comportamento prevalente**: {{ d(comportamento_prevalente, 'es. introverso, impulsivo, empatico') }}\n- **Stile decisionale**: {{ d(stile_decisionale, 'es. segue l‚Äôistinto, valuta i rischi, ecc.') }}\n- **Motto/Frase tipica/Modi di dire/Accento**: {{ d(motto_o_frase, 'es. accento locale, intercalare ricorrente') }}\n- **Spunti per interpretazione**: {{ d(spunti_interpretativi, 'es. parla per enigmi, ama raccontare storie') }}\n- **Background Narrativo**: {{ d(background_narrativo, 'breve backstory coerente con razza, classe e tratti') }}\n\n---\n\n{# ========== LIBRO MASTRO DELL‚ÄôAVVENTURIERO (LEDGER) ========== #}\n{% if SHOW_LEDGER %}\n## üí∞ Adventurer Ledger ‚Äî KPI & Movimenti\n{% set cur_pp = (currency.pp if currency is defined else pp) | default(0) %}\n{% set cur_gp = (currency.gp if currency is defined else gp) | default(0) %}\n{% set cur_sp = (currency.sp if currency is defined else sp) | default(0) %}\n{% set cur_cp = (currency.cp if currency is defined else cp) | default(0) %}\n{% set gp_liquidi = to_gp(cur_pp,cur_gp,cur_sp,cur_cp) %}\n{% set gp_investiti = ledger_invested_gp | default(0) %}\n{% set gp_totali = gp_liquidi + gp_investiti %}\n{% set wbl_target_gp = wbl_target_gp | default(next_wbl_gp | default(0)) %}\n{% set wbl_delta_gp = (gp_totali - (wbl_target_gp|float)) %}\n\n- **Cassa (liquidi):** {{ coin_str(cur_pp,cur_gp,cur_sp,cur_cp) }} = **{{ fmt_gp(gp_liquidi) }}**  \n- **Valore investito (gear):** **{{ fmt_gp(gp_investiti) }}** ¬∑ **Wealth totale:** **{{ fmt_gp(gp_totali) }}**  \n- **WBL target (liv {{ get_total_level(CL)|default(1) }}):** {{ fmt_gp(wbl_target_gp) }} ¬∑ **Œî vs WBL:** {{ signed((wbl_delta_gp)|round(1)) }} gp  \n- **Encumbrance hint:** {{ d(ledger_encumbrance_hint, 'ok') }}\n\n### Movimenti (ultimi / sessione)\n| Data | Tipo | Oggetto/Voce | Q.t√† | Val. unit | Totale | Œî GP | Fonte (AP/SX) | PFS |\n|---|---|---|---:|---:|---:|---:|---|:--:|\n{% for m in (ledger_movimenti or []) -%}\n| {{ d(m.data) }} | {{ d(m.tipo) }} | {{ d(m.oggetto) }} | {{ d(m.qty,1) }} | {{ d(m.vu) }} | {{ d(m.tot) }} | {{ d(m.delta_gp) }} | {{ d(m.source) }} | {{ '‚úì' if m.pfs else '' }} |\n{%- endfor %}\n{% if (ledger_movimenti or [])|length == 0 %}_Nessun movimento registrato._{% endif %}\n\n### Loot Parcels (non ancora liquidati)\n| Parcella | Stima gp | Assegnatario | Note |\n|---|---:|---|---|\n{% for p in (ledger_parcels or []) -%}\n| {{ d(p.nome) }} | {{ d(p.val_gp) }} | {{ d(p.assegnatario) }} | {{ d(p.note) }} |\n{%- endfor %}\n{% if (ledger_parcels or [])|length == 0 %}_Nessun loot in attesa._{% endif %}\n\n### Coda Crafting\n| Item | DC | Giorni | Costo materie | Risparmio | Stato |\n|---|---:|---:|---:|---:|---|\n{% for c in (ledger_crafting or []) -%}\n| {{ d(c.item) }} | {{ d(c.dc) }} | {{ d(c.days) }} | {{ d(c.cost) }} | {{ d(c.saving) }} | {{ d(c.status,'open') }} |\n{%- endfor %}\n{% if (ledger_crafting or [])|length == 0 %}_Nessun crafting pianificato._{% endif %}\n\n### Audit & PFS\n- **Flag non PFS-legal:** {{ d(ledger_pfs_flags, '‚Äî') }}\n- **Note GM/Audit:** {{ d(ledger_audit_notes, '‚Äî') }}\n\n{% endif %}\n\n{% if not PRINT_MODE and SHOW_VTT %}\n---\n## Hook VTT / Export\n- **Map ID:** {{ d(map_id) }} | **Bundle asset:** {{ d(vtt_bundle_path) }}\n- **Preset luci:** {{ d(vtt_light, 'day') }} | **Token scale:** {{ d(token_scale_hint, 'M') }}\n- **Grid consigliata:** {{ d(recommended_grid_size) }} | **Safe/Bleed:** {{ d(safe_area_pct, 5) }}% / {{ d(bleed_pct, 2) }}%\n- **Note GM:** {{ d(vtt_gm_notes) }}  <!-- 2‚Äì3 POI, percorsi, consigli Foundry/Roll20 -->\n- **Formati supportati:** Markdown strutturato, JSON ledger/vtt_json, blocchi compatibili con VTT.\n- **Note localizzazione numerica:** separatore {{ ',' if DECIMAL_COMMA else '.' }}, unit√† in gp.\n- **CTA export:** /export_pg_sheet ‚Ä¢ /export_pg_sheet_json\n{% endif %}\n\n---\n\n{# ========== SEZIONE DIDATTICA INTEGRATA (EXPLAIN) ========== #}\n{% if not PRINT_MODE and SHOW_EXPLAIN %}\n---\n## Explain ‚Äì Regola & Procedura (multi‚Äëmetodo)\n- **Regola (in una riga):** {{ d(explain.tldr) }}\n- **Contesto & Scopo:** {{ d(explain.context) }}\n\n### Procedura passo‚Äëpasso\n{{ d(explain.step_by_step) }}\n\n### Metodo 2 ‚Äì Algoritmico / Flow\n{{ d(explain.algorithmic) }}\n\n### Metodo 3 ‚Äì Analogia / Metafora\n{{ d(explain.analogy) }}\n\n### Errori comuni (e come evitarli)\n{{ d(explain.common_mistakes) }}\n\n### RAW vs RAI (edge cases)\n{{ d(explain.raw_vs_rai) }}\n\n### Esempio numerico rapido\n{{ d(explain.numeric_example) }}\n\n### Verifica / Quiz lampo (3 domande)\n{{ d(explain.quick_quiz) }}\n\n### Checklist di applicazione al tavolo\n- {{ d(explain.checklist) }}\n\n### Fonti didattiche (puntuali)\n- {{ d(explain.sources) }}  {# es. AoN ‚Üí CRB p.X; FAQ Paizo (link), blog dev #}\n{% endif %}\n\n{# ========== TECNICO/ANALISI (toggle) ========== #}\n{% if not PRINT_MODE and SHOW_MINMAX %}\n---\n## Analisi MinMax\n- **DPR medio (base/nova):** {{ d(STK.DPR_Base) }} / {{ d(STK.DPR_Nova) }}\n- **Sostenibilit√† difensiva:** {{ d(BM.Defense_status) }} {{ (BM.Defense_delta ~ '%') if BM.Defense_delta is not none else '' }}\n- **Meta Tier:** {{ d(BM.meta_tier, STK.meta_tier) }}\n\n**Benchmark (auto) ‚Äî Ref: {{ d(benchmark_reference_label, FIRST_CLASS) }}**\n| Parametro | Stato | Œî vs Ref |\n|---|---:|---:|\n| DPR 1‚Äì3 | {{ d(BM.DPR_early_status) }} | {{ BM.DPR_early_delta if BM.DPR_early_delta is not none else '‚Äî' }}% |\n| DPR 4+  | {{ d(BM.DPR_late_status)  }} | {{ BM.DPR_late_delta  if BM.DPR_late_delta  is not none else '‚Äî' }}% |\n| Difesa  | {{ d(BM.Defense_status)   }} | {{ BM.Defense_delta   if BM.Defense_delta   is not none else '‚Äî' }}% |\n| Buff    | {{ d(BM.Buff_status) }} | ‚Äì |\n| Azioni  | {{ d(BM.Actions_status) }} | ‚Äì |\n| Scaling | {{ d(BM.Scaling_status) }} | ‚Äì |\n\nüî• **Risk Heatmap (‚â•2):** Feat ‚Üí {{ j(BM.risk_top3.feats) }} ¬∑ Spell ‚Üí {{ j(BM.risk_top3.spells) }}  \nüè∑ **Origine suggerimenti:** {{ source_mix_summary() }}\n{% if benchmark_comparison %}\n---\n## Benchmark Comparativo\n**Riferimento:** {{ benchmark_comparison.reference_label }} ({{ 'Auto' if benchmark_comparison.auto else 'Manuale' }}){% if benchmark_comparison.timestamp %} ‚Äî {{ benchmark_comparison.timestamp }}{% endif %}\n| Categoria | Stato | Œî % |\n|---|---|---:|\n{% for k,v in benchmark_comparison.comparison.items() -%}\n| {{ k }} | {{ v.status }} | {{ v.diff }} |\n{%- endfor %}\n{% endif %}\n\n{% if not PRINT_MODE and SHOW_QA %}\n---\n## QA rapido\n- **Tabelle popolate?:** armi/skill/incantesimi non vuote o placeholder indicato.\n- **Valute normalizzate:** {{ coin_str(pp, gp, sp, cp) }} (usa fmt_gp per export).\n- **Coerenza WBL:** Œî vs target {{ d(wbl_delta_gp) }} gp; vendite/acquisti loggati nel ledger.\n- **Badge/Lingua:** tag PFS/RAW se noti; lingua coerente con prompt.\n{% endif %}\n\n---\n## Output checklist (inserire nel render finale)\n- Header con toggle attivi (MINMAX/VTT/QA/EXPLAIN/LEDGER) e lingua.\n- Fonti/tag: RAW/PFS/HR/META e richiami al Ledger/Explain/MinMax usati.\n- Struttura minima: sommario PG, blocchi statistici, economia (ledger/WBL), eventuale sezione Explain/MinMax.\n- Dati numerici formattati con {{ ',' if DECIMAL_COMMA else '.' }} come separatore decimale e unit√† gp/%. \n- Sezioni vuote: sostituire con placeholder espliciti per evitare header orfani.\n{% endif %}\n\n{% if not PRINT_MODE %}\n---\n## Suggerimenti interpretativi\n- {{ d(spunti_interpretativi) }}\n{% endif %}\n\n---\n> üìé Fonti Meta (badge sintetico): {{ lookup_meta_badges('any') or '‚Äî' }}\n\n---\n## Profilo ruolistico (‚Äúalla Locanda‚Äù)\n- **Modello psicologico:** {{ d(modello_psico) }} (es. Jung/OCEAN/Enneagramma)  \n- **Stile decisionale:** {{ d(stile_decisionale) }}  \n- **Storia personale (perch√© in avventura):** {{ d(storia_personale) }}  \n- **Relazioni & legami:** {{ d(relazioni_legami) }} *(un PNG caro, una rivalit√†, un giuramento)*  \n- **Ganci di campagna:** {{ d(ganci_campagna) }} *(per restare nel party)*  \n- **Flavor RP:** {{ d(flavor_rp) }} *(tic, frasi tipiche, feticci/ricordi)*\n\n---\n## Canone & Fonti\n- **Edizione di riferimento:** PF1e  \n- **Fonti primarie (üìó):** {{ d(fonti_primarie) }}  \n- **Secondarie (üîé):** {{ d(fonti_secondarie) }}  \n- **Varianti PFS-Lore (üß≠):** {{ d(pfs_varianti) }}  \n- **Dev Insight (üß™):** {{ d(dev_insight) }}  \n- **House Lore (‚ùó):** {{ d(house_lore_note) }}  \n- **Citazioni brevi (‚â§25 parole):**\n{% for c in (citazioni_brevi or []) -%}\n- ‚Äú{{ c.estratto }}‚Äù ‚Äî {{ c.fonte }}{{ ' ' ~ c.pagina_opz if c.pagina_opz else '' }}\n{%- endfor %}\n\n---\n## Collegamenti di Campagna\n- **SX00 (dashboard):** {{ d(sx00_link) }}\n- **AV corrente:** {{ d(av_code) }} | **SX correlate:** {{ d(sx_codes) }}\n- **Fazioni (NC) collegate:** {{ d(fazioni_collegate) }}\n- **Thread aperti / milestone:** {{ d(thread_aperti) }}\n{% if not PRINT_MODE and SHOW_QA %}\n---\n## QA & Spoiler\n- **spoiler_mode:** {{ d(spoiler_mode, 'light') }}  \n- **AP warning:** {{ d(ap_warning) }}  \n- **Confidence:** {{ d(confidence_score) }} | **Uncertainty flags:** {{ d(uncertainty_flags) }}\n\n{% if glossario_golarion %}\n---\n## Glossario Golarion (rapido)\n{% for g in glossario_golarion.termini or [] -%}\n- **{{ g.termine }}**: {{ g.def }}\n{%- endfor %}\n{% endif %}\n\n---\n## Canone & Fonti META\n- **Fonti (RAW/PFS se presenti):** {{ (fonti or []) | join(', ') if fonti else '‚Äî' }}\n- **Fonti META (ord. autorit√†):** {% for f in (fonti_meta or []) %}{{ f.badge }} [{{ f.tipo }}]({{ f.link }}){% if not loop.last %} ¬∑ {% endif %}{% endfor %}\n\n---\n## Regole & QA\n- **Regole attive:** {{ rules_status_text() }}  \n- **QA export gate:** Core={{ 'OK' if validate_core_ok else '‚Äî' }}, Feats={{ 'OK' if validate_feats_ok else '‚Äî' }}, Sim={{ 'OK' if simulate_ok else '‚Äî' }}\n{% endif %}\n\n"
          },
          "velocita": 0,
          "iniziativa": 0,
          "pf_totali": 0,
          "skill_points": 0,
          "sheet_markdown": "### üßô Scheda Personaggio in Markdown\n\n---\n\n\n\n\n\n\n\n  \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n# ‚Äî ‚Äî Liv. 1 (‚Äî ¬∑ Psychic (1) ‚Äî Base)\n\n**Allineamento:**   \n**Divinit√†:**   \n**Taglia:**  | **Et√†:**  | **Sesso:**  | **Altezza/Peso:**  /   \n**Ruolo consigliato:**   \n**Stile interpretativo:**  ‚Äî ‚Äî  \n**Background breve (5‚Äì10 righe):** \n\n---\n\n## Statistiche fondamentali\n- **For** 10 (mod 0)\n- **Des** 10 (mod 0)\n- **Cos** 10 (mod 0)\n- **Int** 10 (mod 0)\n- **Sag** 10 (mod 0)\n- **Car** 10 (mod 0)\n\n- **PF (HP):**  | **CA:**   \n- **CA (breakdown):** 17 = 10 + Arm 0 + Scudo 0 + Des 0 + Defl 0 + Nat 0 + Dodge 0 + Altro 0  \n- **CA Var.:** Contatto 10 ¬∑ Colto alla sprovvista 10  \n- **Tiri Salvezza:** Temp 0 / Riflessi 0 / Volont√† 0  \n- **BAB:** 0 | **Iniziativa:** 0 | **Velocit√†:** 0  \n- **CMB/CMD:** 0 / 0  \n\n\n- **CMD (dettaglio):** 0 = 10 + BAB 0 + For/Des 0 + Des 0 + Taglia 0 + Altro 0\n\n- **PE (XP):**  / \n\n---\n\n## Difese Speciali\n- **RD/Res/Imm:**   \n- **RS:**  | **Guarigione rapida/Rigenerazione:**   \n- **Sensi:**  | **Percezione (tot):** \n\n---\n\n## Combattimento\n### Armi e attacchi\n| Arma | Tipo | Attacco | Danni | Critico | Portata | Note |\n|---|---|---:|---|---|---|---|\n\n_(Nessuna arma strutturata: derivabile da `equipaggiamento` o aggiungerla qui.)_\n\n- **Attacchi naturali:**   \n- **Capacit√† speciali:** \n\n### Manovre CMB\n| Manovra | Bonus |\n|---|---:|\n| Disarm |  |\n| Trip   |  |\n| Grapple|  |\n| Bull Rush |  |\n| Sunder |  |\n\n---\n\n## Economia d‚ÄôAzione\n- **AoO/round:**   \n- **Swift usata?:**   \n- **Immediate pronte?:** \n\n---\n\n## Armatura (tecnica)\n- **ACP:**  | **Max Des:**  | **ASF:** % | **Velocit√† ridotta:** \n\n---\n\n## Abilit√† (Skills)\n| Abilit√† | Gradi | Mod Car | Var | Classe? | Totale |\n|---|---:|---:|---:|:--:|---:|\n\n_Nessuna abilit√† strutturata._\n\n---\n\n## Talenti, Tratti & Difetti\n- **Talenti:** ‚Äî\n- **Tratti:** ‚Äî\n- **Difetti:** \n\n---\n\n## Poteri di Classe / Archetipi\n\n\n**Usi/giorno chiave:** \n\n---\n\n## Incantesimi / Capacit√† Magiche\n- **Classe da incantatore:**   \n- **CD base incantesimi:**  | **LI:**   \n- **Slot per giorno:** \n\n**Conosciuti/Preparati**\n\n_Nessun incantesimo conosciuto o preparato specificato._\n\n\n_Nessuna tabella incantesimi disponibile._\n\n\n### Incantatore (tecnico)\n\n- **Concentrazione:** \n\n- **Penetrazione Magica:**   \n- **CD per Scuola:** \n\n---\n\n## Routine di Round (rapida)\n1) **Buff chiave:**   \n2) **Posizionamento:**   \n3) **Output:**   \n**Priorit√† reattive:** \n\n---\n\n## Risorse Giornaliere\n| Risorsa | Max | Usate | Rimaste | Reset |\n|---|---:|---:|---:|---|\n\n\n| Rage / Ki / Panache / Grit / Arcane Pool / Performance |  |  | 0 |  |\n\n\n---\n\n## Consumabili\n- **Pozioni:**   \n- **Pergamene:**   \n- **Bacchette (cariche):** \n\n---\n\n## WBL & Shopping\n- **Budget attuale:** 0 gp | **Breakpoint prossimo:** 0 gp\n- **Priorit√† acquisti:** \n\n---\n\n## Equipaggiamento\n- ‚Äî\n- **Armi/Armature/Oggetti:**   \n- **Peso totale trasportato:**   \n- **Capacit√† di trasporto:** L  / M  / P   \n- **Valute:** Rame 0 ‚Ä¢ Argento 0 ‚Ä¢ Oro 0 ‚Ä¢ Platino 0\n\n---\n\n## Lingue & Varie\n- **Lingue:** ‚Äî  \n- **Punti Eroe (opz.):**   \n- **Altre note:** \n\n---\n\n## Companion / Famigli\n\n\n---\n\n## Psicologia & Roleplay\n- **Sinergie**: \n- **Teoria dominante**: \n- **Comportamento prevalente**: \n- **Stile decisionale**: \n- **Motto/Frase tipica/Modi di dire/Accento**: \n- **Spunti per interpretazione**: \n- **Background Narrativo**: \n\n---\n\n\n\n## üí∞ Adventurer Ledger ‚Äî KPI & Movimenti\n\n\n\n\n\n\n\n\n\n\n- **Cassa (liquidi):** PP 0 ‚Ä¢ GP 0 ‚Ä¢ SP 0 ‚Ä¢ CP 0 = **0 gp**  \n- **Valore investito (gear):** **0 gp** ¬∑ **Wealth totale:** **0 gp**  \n- **WBL target (liv 1):** 0 gp ¬∑ **Œî vs WBL:** 0.0 gp  \n- **Encumbrance hint:** \n\n### Movimenti (ultimi / sessione)\n| Data | Tipo | Oggetto/Voce | Q.t√† | Val. unit | Totale | Œî GP | Fonte (AP/SX) | PFS |\n|---|---|---|---:|---:|---:|---:|---|:--:|\n\n_Nessun movimento registrato._\n\n### Loot Parcels (non ancora liquidati)\n| Parcella | Stima gp | Assegnatario | Note |\n|---|---:|---|---|\n\n_Nessun loot in attesa._\n\n### Coda Crafting\n| Item | DC | Giorni | Costo materie | Risparmio | Stato |\n|---|---:|---:|---:|---:|---|\n\n_Nessun crafting pianificato._\n\n### Audit & PFS\n- **Flag non PFS-legal:** \n- **Note GM/Audit:** \n\n\n\n\n---\n## Hook VTT / Export\n- **Map ID:**  | **Bundle asset:** \n- **Preset luci:**  | **Token scale:** \n- **Grid consigliata:**  | **Safe/Bleed:** % / %\n- **Note GM:**   <!-- 2‚Äì3 POI, percorsi, consigli Foundry/Roll20 -->\n- **Formati supportati:** Markdown strutturato, JSON ledger/vtt_json, blocchi compatibili con VTT.\n- **Note localizzazione numerica:** separatore ,, unit√† in gp.\n- **CTA export:** /export_pg_sheet ‚Ä¢ /export_pg_sheet_json\n\n\n---\n\n\n\n---\n## Explain ‚Äì Regola & Procedura (multi‚Äëmetodo)\n- **Regola (in una riga):** \n- **Contesto & Scopo:** \n\n### Procedura passo‚Äëpasso\n\n\n### Metodo 2 ‚Äì Algoritmico / Flow\n\n\n### Metodo 3 ‚Äì Analogia / Metafora\n\n\n### Errori comuni (e come evitarli)\n\n\n### RAW vs RAI (edge cases)\n\n\n### Esempio numerico rapido\n\n\n### Verifica / Quiz lampo (3 domande)\n\n\n### Checklist di applicazione al tavolo\n- \n\n### Fonti didattiche (puntuali)\n-   \n\n\n\n\n---\n## Analisi MinMax\n- **DPR medio (base/nova):**  / \n- **Sostenibilit√† difensiva:**  %\n- **Meta Tier:** T3\n\n**Benchmark (auto) ‚Äî Ref: **\n| Parametro | Stato | Œî vs Ref |\n|---|---:|---:|\n| DPR 1‚Äì3 |  | % |\n| DPR 4+  |  | % |\n| Difesa  |  | % |\n| Buff    |  | ‚Äì |\n| Azioni  |  | ‚Äì |\n| Scaling |  | ‚Äì |\n\nüî• **Risk Heatmap (‚â•2):** Feat ‚Üí  ¬∑ Spell ‚Üí   \nüè∑ **Origine suggerimenti:** None\n\n\n\n---\n## QA rapido\n- **Tabelle popolate?:** armi/skill/incantesimi non vuote o placeholder indicato.\n- **Valute normalizzate:** PP 0 ‚Ä¢ GP 0 ‚Ä¢ SP 0 ‚Ä¢ CP 0 (usa fmt_gp per export).\n- **Coerenza WBL:** Œî vs target 0.0 gp; vendite/acquisti loggati nel ledger.\n- **Badge/Lingua:** tag PFS/RAW se noti; lingua coerente con prompt.\n\n\n---\n## Output checklist (inserire nel render finale)\n- Header con toggle attivi (MINMAX/VTT/QA/EXPLAIN/LEDGER) e lingua.\n- Fonti/tag: RAW/PFS/HR/META e richiami al Ledger/Explain/MinMax usati.\n- Struttura minima: sommario PG, blocchi statistici, economia (ledger/WBL), eventuale sezione Explain/MinMax.\n- Dati numerici formattati con , come separatore decimale e unit√† gp/%. \n- Sezioni vuote: sostituire con placeholder espliciti per evitare header orfani.\n\n\n\n---\n## Suggerimenti interpretativi\n- \n\n\n---\n> üìé Fonti Meta (badge sintetico): ‚Äî\n\n---\n## Profilo ruolistico (‚Äúalla Locanda‚Äù)\n- **Modello psicologico:**  (es. Jung/OCEAN/Enneagramma)  \n- **Stile decisionale:**   \n- **Storia personale (perch√© in avventura):**   \n- **Relazioni & legami:**  *(un PNG caro, una rivalit√†, un giuramento)*  \n- **Ganci di campagna:**  *(per restare nel party)*  \n- **Flavor RP:**  *(tic, frasi tipiche, feticci/ricordi)*\n\n---\n## Canone & Fonti\n- **Edizione di riferimento:** PF1e  \n- **Fonti primarie (üìó):**   \n- **Secondarie (üîé):**   \n- **Varianti PFS-Lore (üß≠):**   \n- **Dev Insight (üß™):**   \n- **House Lore (‚ùó):**   \n- **Citazioni brevi (‚â§25 parole):**\n\n\n---\n## Collegamenti di Campagna\n- **SX00 (dashboard):** \n- **AV corrente:**  | **SX correlate:** \n- **Fazioni (NC) collegate:** \n- **Thread aperti / milestone:** \n\n---\n## QA & Spoiler\n- **spoiler_mode:**   \n- **AP warning:**   \n- **Confidence:**  | **Uncertainty flags:** \n\n\n\n---\n## Canone & Fonti META\n- **Fonti (RAW/PFS se presenti):** ‚Äî\n- **Fonti META (ord. autorit√†):** \n\n---\n## Regole & QA\n- **Regole attive:** None  \n- **QA export gate:** Core=‚Äî, Feats=‚Äî, Sim=‚Äî\n\n",
          "salvezze_breakdown": {
            "Tempra": {
              "totale": 0,
              "base": 0,
              "modificatore": 0,
              "misc": 0
            },
            "Riflessi": {
              "totale": 0,
              "base": 0,
              "modificatore": 0,
              "misc": 0
            },
            "Volont√†": {
              "totale": 0,
              "base": 0,
              "modificatore": 0,
              "misc": 0
            },
            "tempra": {
              "totale": 0,
              "base": 0,
              "modificatore": 0,
              "misc": 0
            },
            "riflessi": {
              "totale": 0,
              "base": 0,
              "modificatore": 0,
              "misc": 0
            },
            "volonta": {
              "totale": 0,
              "base": 0,
              "modificatore": 0,
              "misc": 0
            }
          },
          "BAB": 0,
          "init": 0,
          "speed": 0,
          "fonti": [
            "http://localhost:8000/modules/minmax_builder.txt?mode=extended&class=Psychic&stub=true&race=Human"
          ],
          "skills_map": {},
          "skills": [],
          "spell_levels": [],
          "magia": {},
          "lingue": [],
          "sensi": [],
          "condizioni": [],
          "equipaggiamento": [],
          "inventario": [],
          "talenti": [],
          "capacita_classe": [],
          "progressione": []
        }
      }
    },
    "narrative": "Human Base pronta/o per il campo, specializzata/o in tattiche da Psychic.",
    "sheet": {
      "classi": [
        {
          "nome": "Psychic",
          "livelli": 1,
          "archetipi": [
            "Base"
          ]
        }
      ],
      "statistiche": {
        "FOR": 16,
        "DES": 14,
        "COS": 14,
        "INT": 10,
        "SAG": 12,
        "CAR": 8
      },
      "statistiche_chiave": {
        "attacco": "+4",
        "danni": "1d8+3",
        "ca": 17
      },
      "benchmarks": {
        "meta_tier": "T3"
      },
      "hooks": null
    },
    "ledger": {
      "movimenti": [
        {
          "voce": "Equipaggiamento iniziale",
          "importo": -150
        },
        {
          "voce": "Ricompensa missione",
          "importo": 250
        }
      ],
      "currency": {
        "oro": 100,
        "argento": 25,
        "rame": 40
      }
    }
  },
  "source_url": "http://localhost:8000/modules/minmax_builder.txt?mode=extended&class=Psychic&stub=true&race=Human",
  "fetched_at": "2025-12-08T17:15:42Z",
  "request": {
    "class": "Psychic",
    "race": "Human",
    "archetype": "Base",
    "mode": "extended",
    "mode_normalized": "extended",
    "spec_id": "Psychic::Human::Base",
    "model": null,
    "background": null
  },
  "query_params": {
    "mode": "extended",
    "class": "Psychic",
    "stub": true,
    "race": "Human"
  },
  "body_params": {},
  "mode_normalized": "extended",
  "step_audit": {
    "normalized_mode": "extended",
    "expected_step_total": 16,
    "observed_step_total": 16,
    "step_total_ok": true,
    "step_labels_count": 16,
    "has_extended_steps": true
  },
  "completeness": {
    "errors": [],
    "require_complete": false
  }
}