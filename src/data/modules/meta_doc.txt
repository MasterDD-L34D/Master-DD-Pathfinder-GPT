module_name: Documenti
version: 1.6
last_updated: 2025-08-23
inherits_from: base_profile.txt
type: module

api_usage:
  note: "Recupera questo modulo via API e non duplicare il kernel nel prompt GPT."
  flow: "Decidi la modalit√† ‚Üí GET /modules/{name} con header x-api-key ‚Üí riformula con badge RAW/RAI/PFS/HR/üß†META."
  sample_call: |
    curl -H "x-api-key: $API_KEY" http://localhost:8000/modules/meta_doc.txt

summary: >-
  Modulo per creare, mantenere e pubblicare la documentazione dei moduli Master DD
  (MinMax Builder, Taverna NPC, Encounter Designer, Adventurer Ledger, Archivist,
  Explain/Ruling). Fornisce blueprint pronti (Spec, README, Changelog, Release Notes,
  Knowledge Pack, Manuale Homebrewery), peer review simulata a 3 esperti e pacchetti ZIP finali.
  Ogni consultazione deve seguire il flusso architettura (`decidi modalit√† ‚Üí GET /modules/{name} con x-api-key ‚Üí riformula`), senza duplicare il kernel nel prompt GPT e mantenendo i tag [RAW]/[RAI]/[PFS]/[HR]/üß†META nelle sezioni esempio.

integrates_with:
  - MinMax Builder
  - Taverna NPC
  - Encounter Designer
  - Adventurer Ledger
  - Archivist
  - Explain Methods
  - Ruling Expert

triggers:
  - "nuovo documento"
  - "crea readme"
  - "release notes"
  - "changelog"
  - "pack finale"
  - "knowledge pack"
  - "diagramma mermaid"
  - "peer review documenti"
  - "indice/toc"
  - "unisci moduli"
  - "mostra guida"
  - "manuale comandi"
  - "non so cosa fare"
  - "spiegami come funziona un modulo"
  - "voglio convertire un GPT in YAML"
  - "genera documentazione del modulo"

welcome_message: |
  üìÑ **Documenti** attivo! Usa `/new_doc`, `/manuale`, `/doc <termine>` o `/doc_pack`.
  Suggerimenti: `/help_docs` per l'elenco, `/howto <comando>` per istruzioni.

# --- DATA MODEL ------------------------------------------------------------
data_structures:
  doc_state:
    # valori esempio spostati in defaults per evitare override
    defaults:
      module_targets: ["Encounter Designer","Taverna NPC","MinMax Builder","Archivist","Explain Methods","Ruling Expert"]
      targets: ["Encounter Designer","Taverna NPC","MinMax Builder","Archivist","Explain Methods","Ruling Expert"]
    id: ""
    title: ""
    kind: "spec"           # spec|readme|release|changelog|knowledge|howto|report|briefing|manuale_brew
    module_targets: []       # es. ["MinMax Builder","Taverna NPC"]
    targets: []              # alias legacy di module_targets
    outline: []              # sezioni ordinate
    sections: {}             # mappa sezione‚Üícontenuto markdown
    sources:
      archivist: []          # citazioni RAW/PFS (badge e ref)
      meta: []               # link guide/analisi (badge META)
      RAW: []
      RAI: []
      PFS: []
      META: []
      primary: []
      reference: []
    embeds:
      minmax_build_cards: []
      taverna_exports: []
      encounters: []
      ledger_snapshots: []
      diagrams: []          # mermaid code blocks
      any: []               # raccolta generica per /embed_from legacy
    style:
      tone: "metodico"
      audience: "GM"
      language: "mixed"     # Nomi ufficiali EN, spiegazioni IT/EN come nel kernel
    review:
      checklist: []
      comments:
        llm_specialist: []
        master_pathfinder: []
        prompt_designer: []
    exports:
      allow_pdf: true
      allow_md: true
      allow_zip: true
      allow_canvas: true
      allow_brew: true
      zip_bundle:
        root_name: "ProjectName_GPT"
        tree:
          - "1_Instructions/"
          - "2_Prompt_Modulari/"
          - "3_Templates/"
          - "4_Diagrammi/"
          - "5_Documentazione/"
          - "README_FIRST.txt"
  # libreria sorgenti META (a livello data_structures)
  sources:
    META:
      - { title: "The Gear Guide", file: "src/data/The Gear Guide.pdf", kind: "META" }
      - { title: "Items Master List", file: "src/data/Items Master List.pdf", kind: "META" }
      - { title: "Useful Items V1.1", file: "src/data/Pathfinder Useful Items List V1.1.pdf", kind: "META" }
      - { title: "Ultimate Crafter Guide", file: "src/data/Ultimate Crafter Guide.pdf", kind: "META" }

# --- HELPERS ---------------------------------------------------------------
helpers:
  today_iso:
    params: []
    logic: |
      import datetime
      return datetime.date.today().isoformat()
  render_badge:
    params: [kind]
    logic: |
      k = (kind or "").lower()
      return {
        "raw": "[RAW]",
        "rai": "[RAI]",
        "pfs": "[PFS]",
        "meta": "üß†",
        "hr": "[HR]",
        "primary": "üèõÔ∏è",
        "reference": "üìñ"
      }.get(k,"‚ùì")
  default_outline_for:
    params: [kind]
    logic: |
      k = (kind or "spec").lower()
      if k == "spec":
        return ["Scopo","Contesto","Requisiti","Flusso","API/Comandi","Dati","QA","Fonti","Note"]
      if k == "readme":
        return ["Panoramica","Setup","Comandi Rapidi","Struttura Cartelle","Integrazioni","FAQ","Licenza"]
      if k == "release":
        return ["Versione","Novit√†","Fix","Migrazioni","Compatibilit√†","Note"]
      if k == "changelog":
        return ["vAttuale","Differenze","Impatto","To-Do"]
      if k == "knowledge":
        return ["Indice File","Sintesi","Riferimenti RAW","Esempi","Checklist"]
      if k == "briefing":
        return ["Ruolo","Expertise","Obiettivi","Formato Output","Elementi trovati","Estensioni"]
      if k == "manuale_brew":
        return ["Copertina","Indice","Capitoli","Appendici"]
      return ["Intro","Contenuto","Note"]
  mermaid_scaffold:
    params: [label]
    logic: |
      L = label or "Flow Documenti"
      return f"flowchart TD\n  A[Start] --> B{{{L}}}\n  B --> C[Draft]\n  C --> D[Peer Review]\n  D --> E[QA]\n  E --> F[Publish]"

# --- HELPERS ‚Äî Homebrewery add-ons -----------------------------------------
  brew_footer:
    params: [title]
    logic: |
      t = title or "Section"
      return f"{{{{footnote {t}}}}}\n{{{{pageNumber,auto}}}}"
  brew_center:
    params: [text, margin_left, margin_right, margin_bottom]
    logic: |
      ml = margin_left or "40px"
      mr = margin_right or "40px"
      mb = margin_bottom or "10px"
      txt = text or ""
      return f"{{{{text-align:center,margin-left:{ml},margin-right:{mr},margin-bottom:{mb}}}}} {txt}"
  brew_image_watercolor:
    params: [mask, offsetX, offsetY, rotation, name, url, style]
    logic: |
      mask = mask or "imageMaskCorner11"
      ox = offsetX or "50%"
      oy = offsetY or "-56%"
      rot = rotation or "0"
      nm = name or "Image"
      st = style or "height:100%,position:absolute,bottom:-720px,right:-500px"
      u = url or "https://i.imgur.com/GZfjDWV.png"
      return f"{{{{{mask},--offsetX:{ox},--offsetY:{oy},--rotation:{rot}\n  ![{nm}]({u})\n  {{{{ {st} }}}}\n}}}}"
  brew_wrap_image:
    params: [side, name, url, extra_styles]
    logic: |
      sd = (side or "left").lower()
      wrap = "wrapLeft" if sd.startswith("l") else "wrapRight"
      nm = name or "Image"
      u = url or "https://i.imgur.com/AXmp4cl.jpeg"
      extra = ("," + extra_styles) if extra_styles else ""
      return f"![{nm}]({u}){{style:{wrap}{extra}}}"

# --- COMMANDS --------------------------------------------------------------
commands:
  /help_docs:
    description: Mostra i comandi principali del modulo Documenti
    action:
      - output: |
          **Comandi Documenti**
          /new_doc <kind> <titolo> ‚Äî crea bozza con outline
          /set_targets [..] ‚Äî collega moduli (MinMax, Taverna, ‚Ä¶)
          /import_template <blueprint> ‚Äî carica struttura pronta
          /embed_from <mod> <id/opzioni> ‚Äî inserisci export da un modulo
          /attach_sources {...} ‚Äî RAW/PFS/META
          /peer_review ‚Äî commenti 3 esperti
          /checklist <preset> ‚Äî checklist operativa
          /toc ‚Äî genera indice automatico
          /section set <name> <md> ‚Äî imposta sezione
          /section append <name> <md> ‚Äî accoda testo alla sezione
          /manuale ‚Äî mostra manuale generato
          /doc <termine> ‚Äî ricerca semantica
          /howto <comando> ‚Äî guida rapida
          /map_docs <scope> ‚Äî mappa ASCII (Core_Profile | Module:<name> | Flow:<cmd>)
          /lint_docs ‚Äî QA/Lint della documentazione
          /patch_suggest ‚Äî diff di patch
          /examples <ambito> ‚Äî esempi
          /convert_gpt_to_module ‚Äî wizard conversione GPT‚ÜíModulo
          /status_docs ‚Äî stato documentazione
          /doc_export ‚Äî esporta manuale breve
          /export_doc <md|pdf|canvas|zip> ‚Äî esporta
          /export_doc_brew ‚Äî esporta Homebrewery V3
          /brew_lint ‚Äî conformit√† V3 (headers/spazi/footers/immagini)
          /render_brew_example <kind> ‚Äî snippet cover/toc/box/image
          /generate_briefing {...} ‚Äî crea Briefing Modulo da template
          /doc_pack ‚Äî crea pacchetto finale (ZIP)

  /new_doc:
    description: Crea un nuovo documento con outline predefinito
    params: [kind, titolo]
    action:
      - set: doc_state.id
        value: '{{ (titolo or kind)|lower|replace(" ","_") }}__{{ today_iso() }}'
      - set: doc_state.title
        value: '{{ titolo }}'
      - set: doc_state.kind
        value: '{{ kind }}'
      - set: doc_state.outline
        value: '{{ default_outline_for(kind) }}'
      - output: "üÜï Documento creato: {{doc_state.title}} ({{doc_state.kind}}) ‚Äî sezioni: {{doc_state.outline}}"

  /set_targets:
    description: Collega il documento a uno o pi√π moduli
    params: [targets]
    action:
      - set: doc_state.module_targets
        value: '{{ targets }}'
      - set: doc_state.targets
        value: '{{ targets }}'
      - output: "üîó Collegati moduli: {{ targets }}"

  /import_template:
    description: Importa un blueprint (spec/readme/release/changelog/knowledge/briefing/manuale_brew)
    params: [blueprint]
    action:
      - if: '{{ blueprint in ["spec","readme","release","changelog","knowledge","briefing","manuale_brew"] }}'
        then:
          - set: doc_state.outline
            value: '{{ default_outline_for(blueprint) }}'
          - output: "üì¶ Blueprint '{{blueprint}}' importato. Outline aggiornato."
        else:
          - output: "‚ö† Blueprint non riconosciuto."

  /embed_from:
    description: Incorpora contenuti da altri moduli (export/snapshot)
    params: [module, opts]
    action:
      - append: doc_state.embeds.any
        value: '{"module": "{{module}}", "options": {{opts}} }'
      - switch: module
        cases:
          - when: 'MinMax'
            do:
              - append: doc_state.embeds.minmax_build_cards
                value: '{{ opts }}'
              - output: "üß© Aggiunta Build Card MinMax: {{opts}}"
          - when: 'Taverna'
            do:
              - append: doc_state.embeds.taverna_exports
                value: '{{ opts }}'
              - output: "üß© Aggiunto export Taverna: {{opts}}"
          - when: 'Encounter'
            do:
              - append: doc_state.embeds.encounters
                value: '{{ opts }}'
              - output: "üß© Aggiunto encounter: {{opts}}"
          - when: 'Ledger'
            do:
              - append: doc_state.embeds.ledger_snapshots
                value: '{{ opts }}'
              - output: "üß© Aggiunto snapshot Ledger: {{opts}}"
          - when: 'Archivist'
            do:
              - append: doc_state.sources.archivist
                value: '{{ opts }}'
              - output: "üìö Aggiunta fonte Archivist: {{opts}}"
          - when: 'Explain'
            do:
              - append: doc_state.sources.meta
                value: '{{ opts }}'
              - output: "üß† Aggiunta fonte META/Explain: {{opts}}"
          - when: 'Ruling'
            do:
              - append: doc_state.sources.archivist
                value: '{{ opts }}'
              - output: "‚öñÔ∏è Aggiunta fonte Ruling: {{opts}}"
          - default:
              - output: "‚ö† Modulo non riconosciuto."

  /diagram:
    description: Inserisce un diagramma Mermaid precompilato
    params: [label]
    action:
      - append: doc_state.embeds.diagrams
        value: '{{ mermaid_scaffold(label) }}'
      - output: "üó∫ Diagramma aggiunto."

  /attach_sources:
    description: Allegare fonti RAW/PFS/META (Archivist/Ruling/Explain)
    params: [raw_refs, pfs_refs, meta_refs]
    action:
      - set: doc_state.sources.archivist
        value: '{{ raw_refs + pfs_refs }}'
      - set: doc_state.sources.meta
        value: '{{ meta_refs }}'
      - set: doc_state.sources.RAW
        value: '{{ raw_refs }}'
      - set: doc_state.sources.PFS
        value: '{{ pfs_refs }}'
      - set: doc_state.sources.META
        value: '{{ meta_refs }}'
      - output: "üìö Fonti allegate: RAW/PFS={{ (raw_refs + pfs_refs)|length }}, META={{ meta_refs|length }}"

  /checklist:
    description: Aggiunge una checklist predefinita
    params: [preset]
    action:
      - set: doc_state.review.checklist
        value: >-
          {{ ['Titolo','Scopo','Contesto','Requisiti','Flusso','API/Comandi','Dati','QA','Fonti','Export'] if preset == 'spec' else
             ['Panoramica','Installazione','Comandi','Esempi','Struttura','FAQ','Licenza'] if preset == 'readme' else
             ['Versione','Novit√†','Fix','Migrazioni','Compatibilit√†','Note'] }}
      - output: "‚úÖ Checklist '{{preset}}' inserita."

  /peer_review:
    description: Esegue review simulata (3 esperti) e produce commenti
    action:
      - set: doc_state.review.comments.llm_specialist
        value:
          - "Controllare i punti di integrazione API fra moduli; definire contratti."
          - "Evitare allucinazioni: citare fonti RAW/PFS nel paragrafo Fonti."
      - set: doc_state.review.comments.master_pathfinder
        value:
          - "Allineare esempi a PF1e (AoN) e segnare PFS-legal."
          - "Aggiungere advices su bilanciamento incontri dove rilevante."
      - set: doc_state.review.comments.prompt_designer
        value:
          - "Rendere i comandi discoverable con /help_docs e esempi."
          - "Modularizzare le sezioni con segnaposto chiari."
      - output: "üßê Peer review generata (LLM, Master, Prompt)."

  /toc:
    description: Genera indice delle sezioni correnti
    action:
      - output: |
          ## Indice
          {% for s in doc_state.outline %}- [{{s}}](#{{ s|lower|replace(' ','-') }}){% endfor %}

  /section:
    description: Gestione sezioni (set/append)
    params: [mode, name, md]
    action:
      - if: '{{ mode == "set" }}'
        then:
          - set: doc_state.sections."{{name}}"
            value: '{{ md }}'
          - output: "‚úèÔ∏è Sezione '{{name}}' aggiornata."
        else:
          - append: doc_state.sections."{{name}}"
            value: |
              {{ md }}
          - output: "‚ûï Testo aggiunto a '{{name}}'."

  /manuale:
    description: Mostra manuale generato dai moduli attivi
    action:
      - output: "üìò Manuale (bozza) generato dalle sezioni configurate in manual_generator."

  /doc:
    description: Ricerca semantica su Core/Moduli/Glossario
    params: [termine]
    action:
      - output: "üîé Ricerca: {{ termine }} ‚Äî metodo: {{ doc_search.method }} (ibrido)."

  /howto:
    description: How-to per un comando caricato (da Core/registry)
    params: [comando]
    action:
      - output: |
          ## How-to: {{ comando }}
          (Template from howto_engine)

  /map_docs:
    description: Mappa ASCII (Core_Profile | Module:<name> | Flow:<cmd>)
    params: [scope]
    action:
      - output: "üó∫Ô∏è Mappa ASCII per scope={{scope}} (vedi visual_mapping)."

  /lint_docs:
    description: QA/Lint della documentazione
    action:
      - output: "üß™ Lint eseguito (vedi lint_docs.checks)."

  /patch_suggest:
    description: Suggerimenti di patch documentali (diff sintetici)
    action:
      - output: "ü©π Patch suggerite con formato {{ patch_suggest.diff_format }}."

  /examples:
    description: Esempi interazione per modulo/comando
    params: [ambito]
    action:
      - output: "üìé Esempi per {{ambito}}."

  /convert_gpt_to_module:
    description: Wizard conversione GPT ‚Üí Modulo YAML
    action:
      - output: "üß™ Avvio wizard conversione GPT‚ÜíModulo."

  /status_docs:
    description: Mostra stato documentazione
    action:
      - output: "üìä Fonti/How-to/Export: vedi sezione /status_docs."

  /doc_export:
    description: Esporta manuale breve (md/pdf)
    action:
      - output: "üì§ Manuale breve esportato."

  /export_doc:
    description: Esporta il documento
    params: [format]
    action:
      - set: local.has_outline
        value: '{{ (doc_state.outline|length) > 0 }}'
      - set: local.has_sources
        value: '{{ (doc_state.sources.archivist|length) > 0 or (doc_state.sources.RAW is defined and (doc_state.sources.RAW|length) > 0) }}'
      - if: '{{ not local.has_outline }}'
        then:
          - output: "‚ùå Export bloccato: outline assente. Usa /import_template."
        else:
          - if: '{{ not local.has_sources }}'
            then:
              - output: "‚ùå Export bloccato: servono almeno 1 RAW/PFS (Archivist/Ruling)."
            else:
              - output: "üì§ Export {{format}} avviato (md/pdf/canvas/zip)."
              - export: '{{ format }}'

  /doc_pack:
    description: Crea pacchetto ZIP finale secondo struttura standard
    action:
      - output: |
          üóÇÔ∏è Creazione pacchetto finale in corso‚Ä¶
          Struttura prevista:
          {{ doc_state.exports.zip_bundle.root_name }}/
          {% for p in doc_state.exports.zip_bundle.tree %}‚îú‚îÄ‚îÄ {{p}}
          {% endfor %}
      - export: zip

  /brew_lint:
    description: Verifica conformit√† Homebrewery V3 (renderer, headers, spacing, footers, immagini)
    action:
      - output: |
          ‚úÖ Brew Lint ‚Äî controlla:
          - Renderer V3 attivo
          - Header corretti (#, ##, ### gialla, #### rossa, ##### nera)
          - Spazi verticali con ':' e &emsp; dove richiesto
          - Uso di {{footnote ...}} e {{pageNumber,auto}} prima dei page break
          - Curly {{ }} per centrare testo e per stile; niente <div>/<span>
          - Immagini: {style:wrapLeft/Right}, transform/rotate, mix-blend-mode; maschere watercolor
          - Tabelle: larghezze a percentuale se serve
  /export_doc_brew:
    description: Esporta il documento in formato Homebrewery (Markdown V3)
    action:
      - output: "üìú Export Homebrewery pronto. Copia il markdown su homebrewery.naturalcrit.com"
      - export: brew

  /render_brew_example:
    description: Restituisce snippet di esempio per Homebrewery (cover/toc/box)
    params: [kind]
    action:
      - switch: kind
        cases:
          - when: 'cover'
            do:
              - output: |
                  :::wide
                  # Manuale di Esempio
                  _Compendio Pathfinder_
                  :::
          - when: 'toc'
            do:
              - output: |
                  ## Table of Contents
                  - [Capitolo 1](#capitolo-1)
                  - [Capitolo 2](#capitolo-2)
          - when: 'box_raw'
            do:
              - output: |
                  >statblock
                  **[RAW]**: Testo regola RAW qui.
          - when: 'box_pfs'
            do:
              - output: |
                  >note
                  **[PFS]**: Specifica legale PFS.
          - when: 'box_meta'
            do:
              - output: |
                  >aside
                  üß† Nota di commento/meta.
          - when: 'wrap_left'
            do:
              - output: |
                  ![Moonphases](https://i.imgur.com/AXmp4cl.jpeg){style:wrapLeft,max-width:35%}
                  {{ transform:rotate(-2deg) }}
          - when: 'watercolor_corner'
            do:
              - output: |
                  {{imageMaskCorner11,--offsetX:50%,--offsetY:-56%,--rotation:0
                    ![MaskTutorial](https://i.imgur.com/GZfjDWV.png)
                    {height:100%,position:absolute,bottom:-720px,right:-500px}
                  }}
          - when: 'center_note'
            do:
              - output: |
                  {{text-align:center,margin-left:40px,margin-right:40px,margin-bottom:10px Testo centrato}}
          - default:
              - output: "‚ö† Tipo di esempio non riconosciuto. Usa cover/toc/box_raw/box_pfs/box_meta/wrap_left/watercolor_corner/center_note."

  /generate_briefing:
    description: Genera un briefing usando lo standard_briefing_template
    params: [ruoli, expertise, obiettivi, estensioni]
    action:
      - output: |
          {{ standard_briefing_template.content }}

# --- BLUEPRINTS (TEMPLATE DI CONTENUTO) ------------------------------------
blueprints:
  spec:
    header: |
      # SPEC ‚Äî {{doc_state.title}}
      **Moduli target:** {{doc_state.module_targets|join(', ')}}
      **Data:** {{today_iso()}}
    sections:
      Scopo: ""
      Contesto: ""
      Requisiti: |
        - Funzionali:
          - [ ] ‚Ä¶
        - Non funzionali:
          - [ ] ‚Ä¶
      Flusso: ""
      API/Comandi: |
        ```
        /comando_esempio args
        ```
      Dati: ""
      QA: ""
      Fonti: ""
      Note: ""
  readme:
    header: |
      # README ‚Äî {{doc_state.title}}
      **Ultimo update:** {{today_iso()}}
    quickstart: |
      ## Comandi Rapidi
      - /help_docs
      - /new_doc spec "Spec Encounter v1.2"
      - /embed_from MinMax {id:"buildA"}
      - /export_doc pdf
  release:
    header: |
      # Release Notes ‚Äî {{doc_state.title}}
      **Data:** {{today_iso()}}
    sections:
      Versione: "vX.Y.Z"
      Novit√†: "- ‚Ä¶"
      Fix: "- ‚Ä¶"
      Migrazioni: "- ‚Ä¶"
      Compatibilit√†: "- MinMax v5+; ABP=ON; PFS=ON"
      Note: "- Tag AP/SX se presenti spoiler."
  changelog:
    header: |
      # Changelog ‚Äî {{doc_state.title}}
      **Data:** {{today_iso()}}
    sections:
      vAttuale: ""
      Differenze: ""
      Impatto: ""
      To-Do: ""
  manuale_brew:
    header: |
      # {{doc_state.title}}
      _Manuale generato da Master DD_
    sections:
      Copertina: |
        :::wide
        # {{doc_state.title}}
        _Compendio Pathfinder_
        :::
      Indice: |
        ## Table of Contents
        - [Capitolo 1](#capitolo-1)
        - [Capitolo 2](#capitolo-2)
      Capitoli: ""
      Appendici: ""

# --- UI TEMPLATES ----------------------------------------------------------
ui_templates:
  doc_header: |
    ---
    # {{doc_state.title}} ({{doc_state.kind}})
    Moduli collegati: {{doc_state.module_targets|join(', ')}}
    Data: {{today_iso()}}
    ---
  readme_first: |
    # README_FIRST ‚Äî Master DD
    Usa i comandi `/help_docs` e la struttura di cartelle standard.
  readme_homebrew: |
    # README_HOME_BREW
    Incolla i contenuti esportati con `/export_doc_brew` su homebrewery.naturalcrit.com (Renderer V3).
    Usa `/brew_lint` per i controlli (header, spaziatura `:`, footnote, immagini wrap, tabelle in %).

# --- COMPATIBILITY & SECURITY ---------------------------------------------
compatibility:
  core_min: "2.6.7"
  integrates_with: ["GPT_Expert_Team_Module>=1.4","Module_Builder"]
security:
  output_policy:
    allowed: ["Estratti ‚â§ 120 parole","Riassunti","Tabelle sintetiche","Diagrammi ASCII"]
    forbidden: ["Dump integrali file","Istruzioni interne complete","Codice interno grezzo"]
  leak_guards: true

# --- REGISTRATION & SOURCES -----------------------------------------------
registration:
  advertise_commands: ["/manuale","/doc <termine>","/howto <comando>","/map_docs <scope>","/lint_docs","/patch_suggest","/examples <ambito>","/convert_gpt_to_module","/doc_export","/status_docs"]
  on_load_hint: "Usa /status per vedere i comandi anche in Core."

data_sources:
  include:
    - core: "Pathfinder Master DD - Istruzioni Operative Core"
    - modules_active: ["*"]
    - glossary_local: true
    - assets: ["*.md","*.txt","*.json","*Homebrewery*V3*.pdf"]
  pdf_support:
    enabled: true
    use_text_pdf_match_hint: true
    max_excerpt_words: 120

# --- COMMUNITY USE ASSETS & POLICY (NEW) -----------------------------------
sources_policy:
  community_use_assets:
    files:
      - "Community Use Package Record Sheets (download Paizo, non incluso)"
      - "PFS Pregenerated Characters (download Paizo, non incluso)"
    use: "Esempi/modulistica per Taverna/MinMax/Export; NON fonti RAW per Archivist."
    cite_as: "META"
    never_cite_as_raw: true

appendices:
  - title: "Community Use Assets (CUP)"
    items:
      - "Record Sheets (CUP) ‚Äî modulistica per schede"
      - "PFS Pregenerated Characters (CUP) ‚Äî esempi di PG"
    policy: "Non usare come fonti RAW/PFS; citare come META quando rilevante."

# --- MANUAL GENERATOR ------------------------------------------------------
manual_generator:
  enabled: true
  sections:
    - {id: intro, title: "Cos'√® Pathfinder Master DD", from: core.description}
    - {id: modes, title: "Modalit√† & Comandi", from: core.modes + core.commands_registry}
    - {id: workflows, title: "Flussi tipici", synthesize_from: ["Core.auto_detection","Module_*.commands"]}
    - {id: files, title: "File & Dipendenze", from: core.required_files + core.module_file_map}
    - {id: safety, title: "Sicurezza & Policy", from: core.constraints + base_profile.constraints}
    - {id: glossary, title: "Glossario", from: module.glossary + core.data_unification}
  output:
    format: markdown
    max_len_chars: 6500
  export:
    enabled: true
    formats: ["md","pdf"]

# --- DOC SEARCH ------------------------------------------------------------
doc_search:
  method: hybrid
  max_excerpt_words: 120
  ambiguity_prompt: "Termine ambiguo: scegli un ambito (Core/Modulo/Glossario/Comando)."
  ranking: ["Core>Module>Glossary>Assets"]
  answer_format:
    sections: ["Sintesi","Estratto (‚â§120w)","Fonte","Voci correlate"]
    show_scopes: true

# --- HOWTO ENGINE ----------------------------------------------------------
howto_engine:
  source: core.commands_registry + modules.commands
  template: |
    ## How-to: {cmd}
    Scopo: {desc}
    Requisiti: {reqs}
    Passi:
    1) ‚Ä¶
  fallbacks:
    missing_cmd: "Comando non trovato nel registry. Prova /status o /manuale."

# --- VISUAL MAPPING --------------------------------------------------------
visual_mapping:
  enabled: true
  trigger_keywords: ["/map_docs","/show_visual_map"]
  scope_options: ["Core_Profile","Module:<name>","Flow:<cmd>"]
  legend: {"‚ñ°":"nodo","‚Üí":"flusso","‚ö†":"check"}
  examples:
    - input: "/map_docs Core_Profile"
      output: |
        [Core]‚Üí[Modes]‚Üí[File Map]‚Üí[Priority]‚Üí[Status]
    - input: "/map_docs Flow:/set_mode"
      output: |
        /set_mode‚Üí[IntentRouter]‚Üí[ModeSwitch]‚Üí[LoadCmds]‚Üí[Confirm/Run]

# --- MDA / QA --------------------------------------------------------------
mda:
  enabled: true
  trigger: "/run_mda Docs"
  passes: ["Technical","Operational","DataModel","FlowLogic","DoubleReview"]
  qa_checklist: ["Nessun loop documentale","Comandi coperti da how-to","Fonti presenti","Limitazione estratti attiva"]

lint_docs:
  checks:
    - missing_sections: ["Intro","Modalit√† & Comandi","Flussi tipici","Sicurezza","Glossario"]
    - broken_refs: true
    - term_consistency: ["RAW","RAI","PFS","House Rule"]
    - command_presence: "Ogni comando nel registry ha un how-to"
  on_fail: "Mostra elenco difetti e propone /patch_suggest"

patch_suggest:
  strategies: [add_missing_section, fix_broken_ref, unify_terms, add_howto_for_command]
  diff_format: "unified"

glossary:
  - {name: "modalit√†", definition: "Contesto operativo definito da un modulo YAML"}
  - {name: "fallback", definition: "Meccanismo di risposta alternativa in caso di errore"}
  - {name: "RAW", definition: "Rules As Written"}
  - {name: "RAI", definition: "Rules As Intended"}
  - {name: "PFS", definition: "Pathfinder Society"}
  - {name: "House Rule", definition: "Regola regionale o di tavolo"}
  - {name: "module_file_map", definition: "Mappa file ‚Üî modalit√† nel Core"}

# --- EXPORTS ---------------------------------------------------------------
export:
  doc_export:
    formats: ["md","pdf","brew"]
    include: ["Manuale Breve","How-to Comandi","Glossario"]

# --- STANDARD BRIEFING TEMPLATE -------------------------------------------
standard_briefing_template:
  title: "Briefing Modulo ‚Äì Struttura Standard"
  description: >
    Modello di briefing operativo per moduli GPT.
    Definisce ruolo, competenze, obiettivi e formato output in modo coerente.
  content: |
    üéì RUOLO:
    Agisci come un LLM professionista specializzato in:
    - [Campo 1]
    - [Campo 2]
    - [Campo 3]
    
    üé≤ ESPERTISE:
    Hai le competenze di:
    - [Profilo professionale 1]
    - [Profilo professionale 2]
    - [Profilo professionale 3]
    
    ---
    
    üß≠ OBIETTIVO:
    Esamina con attenzione l‚Äôinput fornito e:
    1. **Identifica elementi chiave** (es. entit√†, oggetti, eventi, regole)
    2. **Estrai e riorganizza** informazioni rilevanti in sezioni chiare
    3. **Ricostruisci** dati o contenuti mancanti quando possibile
    4. **Verifica coerenza** rispetto a fonti o vincoli dichiarati
    5. **Genera output** nel formato definito
    
    ---
    
    ‚úçÔ∏è FORMATO OUTPUT:
    - Titolo / Nome
    - Categoria o tipo
    - Contesto o origine
    - Caratteristiche o attributi
    - Note tecniche / regolamentari
    - Eventuali citazioni / riferimenti
    
    ---
    
    üìå Alla fine della scansione:
    1. Elenca elementi trovati con livello di completezza
    2. Suggerisci eventuali estensioni, collegamenti o approfondimenti
    
    ---
    
    üß∞ ESTENSIONE OPZIONALE:
    Se attivata, proponi:
    - Creazione di schede riassuntive (canvas)
    - Preparazione di un PDF formattato
    - Collegamenti a moduli o dati correlati

# --- QA / GATES ------------------------------------------------------------
qa_templates:
  errors:
    missing_sources: "Aggiungi almeno 1 fonte RAW o PFS."
    empty_outline: "Outline vuoto: usa /import_template."
    missing_release_version: "Release Notes senza 'Versione'."
  gates:
    export_requires:
      - doc_state.outline|length > 0
      - doc_state.sources.archivist|length > 0
      - (doc_state.kind != 'release') or (doc_state.sections.Versione is defined)

# --- FLOW ------------------------------------------------------------------
flow:
  steps: [Draft, PeerReview, QA, Publish]
  cta:
    primary: {text: "Avvia Peer Review", command: /peer_review}

notes:
  compatibility: >-
    Il modulo √® pensato per agganciarsi ai comandi export degli altri moduli
    (MinMax build_card, Taverna export, Encounter JSON, Ledger tabelle). Mantiene
    separazione tra RAW/PFS e META con badge chiari. Include TOC, gestione sezioni,
    e gate extra per Release Notes. Compatibile con Homebrewery V3 (renderer) e
    con la Documentazione dinamica (manuale, /doc, mappa ASCII, MDA, Lint).
  limits: "Preferisce estratti/riassunti; il dump completo √® consentito solo se il server espone ALLOW_MODULE_DUMP=true."
  community_use_assets_note: >-
    I pacchetti Community Use (Record Sheets, PFS Pregenerated Characters) sono considerati asset di esempio/modulistica.
    NON vanno citati come fonti RAW/PFS dell'Archivist; se richiamati nella Documentazione, etichettarli sempre come META.
